<!doctype html>
<html lang="en" class="h-full">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Company Employee Billing System</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDhFPkbWztYZ3D58zHd3D-jSTiydYsIQKA",
      authDomain: "soun-c94a4.firebaseapp.com",
      projectId: "soun-c94a4",
      storageBucket: "soun-c94a4.firebasestorage.app",
      messagingSenderId: "708216304164",
      appId: "1:708216304164:web:e7c0cc5111826c95471eb1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Expose Firebase to global window for non-module data_sdk.js
    window.firebaseDb = db;
    window.firebaseFirestore = { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, setDoc, query, orderBy };
    window.dispatchEvent(new Event('firebase-ready'));
  </script>
  <script src="./_sdk/element_sdk.js" defer></script>
  <script src="./_sdk/data_sdk.js" defer></script>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap"
    rel="stylesheet">
  <style>
    .glass-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    .glass-dark {
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .card-hover:hover {
      transform: translateY(-5px) scale(1.01);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    .tab-btn {
      transition: all 0.2s ease;
      position: relative;
    }

    .tab-btn.active {
      color: #2563EB;
      font-weight: 600;
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background: #2563EB;
      border-radius: 3px 3px 0 0;
    }

    .modal-overlay {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(6px);
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal-content {
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .toast {
      animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(8px);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%) scale(0.9);
      }

      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    .food-item-card {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      user-select: none;
    }

    .food-item-card:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
      z-index: 10;
    }

    .food-item-card:active {
      transform: scale(0.95);
    }

    .limit-warning {
      background: #FEF2F2;
      border: 2px solid #FCA5A5;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      animation: shake 0.5s ease;
      box-shadow: 0 4px 6px rgba(220, 38, 38, 0.1);
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-8px);
      }

      75% {
        transform: translateX(8px);
      }
    }

    #app::-webkit-scrollbar {
      width: 8px;
    }

    #app::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
    }

    #app::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    #app::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    @media print {

      /* 80mm Thermal Printer Optimization */
      @page {
        size: 80mm auto;
        margin: 0;
      }

      * {
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
      }

      body {
        margin: 0;
        padding: 0;
        width: 80mm;
        font-family: 'Courier New', monospace;
        font-size: 11pt;
        line-height: 1.3;
      }

      body * {
        visibility: hidden;
      }

      #print-area,
      #print-area * {
        visibility: visible;
      }

      #print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 80mm;
        padding: 2mm 4mm;
        margin: 0;
        box-sizing: border-box;
        font-size: 11pt;
      }

      /* Receipt-specific typography */
      #print-area h1,
      #print-area h2,
      #print-area h3 {
        margin: 0 0 2mm 0;
        padding: 0;
        font-weight: bold;
        text-align: center;
      }

      #print-area h1 {
        font-size: 14pt;
      }

      #print-area h2 {
        font-size: 12pt;
      }

      #print-area h3 {
        font-size: 11pt;
      }

      /* Hide shadows, borders, backgrounds for clean receipt */
      #print-area * {
        box-shadow: none !important;
        text-shadow: none !important;
        background: transparent !important;
        border-radius: 0 !important;
      }

      /* Table formatting for items */
      #print-area table {
        width: 100%;
        border-collapse: collapse;
        margin: 2mm 0;
      }

      #print-area table th,
      #print-area table td {
        padding: 1mm 0;
        text-align: left;
        border: none;
        font-size: 10pt;
      }

      #print-area table th {
        border-bottom: 1px dashed #000;
        font-weight: bold;
      }

      #print-area table .text-right,
      #print-area .text-right {
        text-align: right !important;
      }

      /* Receipt dividers */
      #print-area hr,
      #print-area .divider {
        border: none;
        border-top: 1px dashed #000;
        margin: 2mm 0;
      }

      /* Total section emphasis */
      #print-area .total-row {
        font-weight: bold;
        font-size: 12pt;
        border-top: 2px solid #000;
        padding-top: 2mm;
        margin-top: 2mm;
      }

      /* Footer text */
      #print-area .footer {
        text-align: center;
        font-size: 9pt;
        margin-top: 4mm;
        padding-top: 2mm;
        border-top: 1px dashed #000;
      }

      /* No page breaks in items */
      #print-area table tr {
        page-break-inside: avoid;
      }
    }
  </style>
  <style>
    @view-transition {
      navigation: auto;
    }
  </style>
</head>

<body class="h-full">
  <div id="loading-screen" class="fixed inset-0 flex items-center justify-center z-50"
    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="text-center">
      <div class="animate-bounce text-8xl mb-6">
        üìä
      </div>
      <div class="text-white text-3xl font-bold mb-2">
        Loading Billing System...
      </div>
      <div class="text-white text-lg opacity-80">
        Please wait
      </div>
    </div>
  </div>
  <div id="app" class="w-full h-full overflow-auto"></div>
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
  <div id="print-area" style="display: none;"></div>
  <script>
    const defaultConfig = {
      app_title: "Billing System",
      currency_symbol: "‚Çπ",
      primary_color: "#2563EB",
      background_color: "#667eea",
      card_color: "#FFFFFF",
      text_color: "#1E293B",
      success_color: "#10B981",
      font_family: "Inter",
      font_size: 14,
      business_name: "My Business",
      business_tagline: "Quality Service, Every Time",
      thank_you_message: "Thank you for your business!",
      footer_note: "This is a computer-generated bill"
    };

    const FOOD_CATEGORIES = ["Breakfast", "Lunch", "Dinner", "Snacks", "Beverages", "Sweets"];

    // Constants
    const MAX_RECORDS = 999;

    // Data SDK variables
    let allData = [];
    let isDataSdkReady = false;
    let hasInitError = false;

    // UI State
    let currentView = 'dashboard';
    let currentBillItems = [];
    let selectedCompanyId = null;
    let selectedEmployeeId = null;
    let selectedMonth = new Date().toISOString().slice(0, 7);
    let companyMonthlyMonthById = {};
    let isSubmitting = false;
    let editingBillId = null;
    let filterDateFrom = '';
    let filterDateTo = '';
    let activeEmployeeTab = 'bills';
    let selectedCategory = 'All';
    let currentPage = 'dashboard';
    let config = { ...defaultConfig };

    // Data SDK Handler
    const dataHandler = {
      onDataChanged(data) {
        allData = data;

        // Only re-render if we're not in the middle of a form submission
        if (!isSubmitting) {
          render();
        }
      }
    };

    // Initialize Data SDK
    async function initDataSdk() {
      if (!window.dataSdk) {
        console.error('Data SDK not available');
        return false;
      }

      const result = await window.dataSdk.init(dataHandler);
      if (result.isOk) {
        isDataSdkReady = true;
        console.log('Data SDK initialized successfully');
        return true;
      } else {
        console.error('Failed to initialize Data SDK:', result.error);
        showToast('Failed to initialize data storage', 'error');
        return false;
      }
    }

    // Render error state
    function renderErrorState() {
      const baseSize = config.font_size || defaultConfig.font_size;
      const bgColor = config.background_color || defaultConfig.background_color;

      return `
        <div class="w-full h-full flex items-center justify-center" style="background: linear-gradient(135deg, ${bgColor} 0%, #764ba2 100%);">
          <div class="bg-white rounded-2xl shadow-2xl p-12 max-w-md text-center">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <h2 class="text-3xl font-bold mb-4" style="color: ${config.primary_color || defaultConfig.primary_color}; font-size: ${baseSize * 2}px;">
              Failed to Load
            </h2>
            <p class="text-gray-600 mb-6" style="font-size: ${baseSize}px;">
              There was an error initializing the billing system. Please refresh the page to try again.
            </p>
            <button onclick="window.location.reload()" class="px-8 py-3 rounded-lg text-white font-semibold" style="background-color: ${config.primary_color || defaultConfig.primary_color}; font-size: ${baseSize}px;">
              Refresh Page
            </button>
          </div>
        </div>
      `;
    }

    // Data operations using Data SDK
    async function createRecord(data) {
      if (!isDataSdkReady) {
        showToast('Data storage not ready', 'error');
        return null;
      }

      if (allData.length >= MAX_RECORDS) {
        showToast(`Maximum limit of ${MAX_RECORDS} records reached. Please delete some items first.`, 'error');
        return null;
      }

      const result = await window.dataSdk.create(data);
      if (result.isOk) {
        // Return the value from SDK which includes the generated __backendId
        return result.value;
      } else {
        showToast('Failed to save data', 'error');
        console.error('Create error:', result.error);
        return null;
      }
    }

    async function updateRecord(updatedRecord) {
      if (!isDataSdkReady) {
        showToast('Data storage not ready', 'error');
        return false;
      }

      const result = await window.dataSdk.update(updatedRecord);
      if (result.isOk) {
        return true;
      } else {
        showToast('Failed to update data', 'error');
        console.error('Update error:', result.error);
        return false;
      }
    }

    async function deleteRecord(record) {
      if (!isDataSdkReady) {
        showToast('Data storage not ready', 'error');
        return false;
      }

      const result = await window.dataSdk.delete(record);
      if (result.isOk) {
        return true;
      } else {
        showToast('Failed to delete data', 'error');
        console.error('Delete error:', result.error);
        return false;
      }
    }

    function getData(type) {
      return allData.filter(item => item.type === type);
    }

    function getCompanies() {
      return getData('company').sort((a, b) => a.name.localeCompare(b.name));
    }

    function getEmployees(companyId = null) {
      const employees = getData('employee');
      return companyId
        ? employees.filter(e => e.companyId === companyId)
        : employees;
    }

    function getBills(filters = {}) {
      let bills = getData('bill').sort((a, b) => b.timestamp - a.timestamp);

      if (filters.companyId) {
        bills = bills.filter(b => b.companyId === filters.companyId);
      }
      if (filters.employeeId) {
        bills = bills.filter(b => b.employeeId === filters.employeeId);
      }
      if (filters.month) {
        bills = bills.filter(b => b.date.startsWith(filters.month));
      }
      if (filters.dateFrom) {
        bills = bills.filter(b => b.date >= filters.dateFrom);
      }
      if (filters.dateTo) {
        bills = bills.filter(b => b.date <= filters.dateTo);
      }

      return bills;
    }

    function getPayments(employeeId = null) {
      const payments = getData('payment').sort((a, b) => b.timestamp - a.timestamp);
      return employeeId ? payments.filter(p => p.employeeId === employeeId) : payments;
    }

    function getFoodItems(category = 'All') {
      const items = getData('foodItem').filter(item => item.isActive);
      return category === 'All'
        ? items.sort((a, b) => a.itemName.localeCompare(b.itemName))
        : items.filter(item => item.category === category).sort((a, b) => a.itemName.localeCompare(b.itemName));
    }

    function getSettings() {
      const settings = getData('settings');
      return settings.length > 0 ? settings[0] : {
        businessName: config.business_name || defaultConfig.business_name,
        businessTagline: config.business_tagline || defaultConfig.business_tagline,
        businessAddress: '',
        businessPhone: '',
        gstNumber: '',
        taxRate: 5,
        printerType: 'A4',
        theme: 'blue',
        thankYouMessage: config.thank_you_message || defaultConfig.thank_you_message,
        footerNote: config.footer_note || defaultConfig.footer_note
      };
    }

    function formatCurrency(amount) {
      const symbol = config.currency_symbol || defaultConfig.currency_symbol;
      return `${symbol}${amount.toFixed(2)}`;
    }

    // Security: Escape HTML entities to prevent XSS
    function escapeHtml(unsafe) {
      if (typeof unsafe !== 'string') return unsafe;
      return unsafe
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast px-6 py-3 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function generateBillNumber() {
      const bills = getBills();
      const maxNumber = bills.length > 0
        ? Math.max(...bills.map(b => b.billNumber || 0))
        : 0;
      return maxNumber + 1;
    }

    function openModal(content) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
      modal.innerHTML = `<div class="modal-content bg-white rounded-2xl shadow-2xl max-w-4xl max-h-[90%] overflow-auto m-4 w-full">${content}</div>`;
      modal.onclick = (e) => {
        if (e.target === modal) closeModal();
      };
      document.body.appendChild(modal);
    }

    function closeModal() {
      const modal = document.querySelector('.modal-overlay');
      if (modal) modal.remove();
    }

    window.closeModal = closeModal;

    // New Bill Page
    function renderNewBillPage() {
      const companies = getCompanies();
      const baseSize = config.font_size || defaultConfig.font_size;

      const limitWarning = allData.length >= MAX_RECORDS ? `
        <div class="limit-warning">
          <div class="flex items-center gap-3">
            <span class="text-4xl">‚ö†Ô∏è</span>
            <div>
              <div class="font-bold text-red-800 text-lg">Maximum Limit Reached</div>
              <div class="text-red-600">You have reached the maximum limit of ${MAX_RECORDS} records. Please delete some items before creating new bills.</div>
            </div>
          </div>
        </div>
      ` : '';

      return `
        <div class="bg-white rounded-2xl shadow-xl p-8">
          <h2 class="text-3xl font-bold mb-6" style="color: ${config.primary_color}; font-size: ${baseSize * 2}px;">${config.app_title || defaultConfig.app_title} - New Bill</h2>
          
          ${limitWarning}
          
          <form id="new-bill-form" class="space-y-6">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="bill-company" class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">Select Company *</label>
                <select id="bill-company" required ${allData.length >= 999 ? 'disabled' : ''} class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none" style="font-size: ${baseSize}px;">
                  <option value="">Choose Company</option>
                  ${companies.map(c => `<option value="${c.__backendId}">${c.name}</option>`).join('')}
                </select>
              </div>
              
              <div>
                <label for="bill-employee" class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">Select Employee *</label>
                <select id="bill-employee" required disabled class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none" style="font-size: ${baseSize}px;">
                  <option value="">Select company first</option>
                </select>
              </div>
            </div>

            <div>
              <label for="bill-date" class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">Bill Date *</label>
              <input type="date" id="bill-date" required value="${new Date().toISOString().split('T')[0]}" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none" style="font-size: ${baseSize}px;">
            </div>

            <div>
              <label for="bill-category" class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">Select Category</label>
              <select id="bill-category" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none" style="font-size: ${baseSize}px;">
                <option value="All">All Categories</option>
                ${FOOD_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
              </select>
            </div>

            <div>
              <div class="flex justify-between items-center mb-3">
                <label class="font-semibold" style="font-size: ${baseSize}px;">Food Items *</label>
                <span id="items-count" class="text-sm text-gray-600" style="font-size: ${baseSize * 0.9}px;">0 items selected</span>
              </div>
              <div id="food-items-grid" class="grid grid-cols-4 gap-3 max-h-80 overflow-y-auto p-4 border-2 border-gray-200 rounded-lg">
                <!-- Food items will be loaded here -->
              </div>
            </div>

            <div>
              <label class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">Selected Items</label>
              <div id="selected-items-list" class="space-y-2 max-h-60 overflow-y-auto p-4 border-2 border-gray-200 rounded-lg bg-gray-50">
                <div class="text-center text-gray-400 py-8" style="font-size: ${baseSize}px;">No items selected</div>
              </div>
            </div>

            <div class="flex items-center justify-between p-4 rounded-lg" style="background-color: ${config.primary_color};">
              <span class="text-white font-bold text-xl" style="font-size: ${baseSize * 1.4}px;">Total Amount:</span>
              <span id="bill-total" class="text-white font-bold text-3xl" style="font-size: ${baseSize * 2}px;">${formatCurrency(0)}</span>
            </div>

            <div class="flex gap-3">
              <button type="button" onclick="navigateToPage('dashboard')" class="flex-1 py-3 rounded-lg border-2 border-gray-300 font-semibold hover:bg-gray-50" style="font-size: ${baseSize}px;">
                Cancel
              </button>
              <button type="submit" id="save-bill-btn" ${allData.length >= 999 ? 'disabled' : ''} class="flex-1 py-3 rounded-lg text-white font-semibold ${allData.length >= 999 ? 'bg-gray-400 cursor-not-allowed' : ''}" style="background-color: ${allData.length >= 999 ? '#9CA3AF' : config.primary_color}; font-size: ${baseSize}px;">
                ${allData.length >= 999 ? 'Limit Reached' : 'Save'}
              </button>
              <button type="button" id="save-print-bill-btn" ${allData.length >= 999 ? 'disabled' : ''} class="flex-1 py-3 rounded-lg text-white font-semibold ${allData.length >= 999 ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}" style="font-size: ${baseSize}px;">
                ${allData.length >= 999 ? 'Limit Reached' : 'Save & Print'}
              </button>
            </div>
          </form>
        </div>
      `;
    }

    function handleCompanyChange(e) {
      const companyId = e.target.value;
      const employeeSelect = document.getElementById('bill-employee');

      if (!employeeSelect) return;

      if (companyId) {
        const employees = getEmployees(companyId);
        employeeSelect.disabled = false;
        employeeSelect.innerHTML = '<option value="">Choose Employee</option>' +
          employees.map(emp => `<option value="${emp.__backendId}">${escapeHtml(emp.name)}</option>`).join('');
      } else {
        employeeSelect.disabled = true;
        employeeSelect.innerHTML = '<option value="">Select company first</option>';
      }
    }

    function loadFoodItems() {
      const categorySelect = document.getElementById('bill-category');
      const category = categorySelect ? categorySelect.value : 'All';
      const foodItems = getFoodItems(category);
      const grid = document.getElementById('food-items-grid');

      if (!grid) return;

      if (foodItems.length === 0) {
        grid.innerHTML = '<div class="col-span-4 text-center text-gray-400 py-8">No food items available</div>';
        return;
      }

      grid.innerHTML = foodItems.map(item => `
        <div class="food-item-card p-3 rounded-lg border-2 border-gray-200 hover:border-blue-500" onclick="addItemToBill('${item.__backendId}', '${item.itemName.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', ${item.price})">
          <div class="text-xs font-semibold text-gray-500 mb-1">${item.category}</div>
          <div class="font-bold text-sm mb-1">${item.itemName}</div>
          <div class="font-bold" style="color: ${config.primary_color};">${formatCurrency(item.price)}</div>
        </div>
      `).join('');
    }

    window.addItemToBill = function (itemId, itemName, price) {
      const existing = currentBillItems.find(item => item.id === itemId);

      if (existing) {
        existing.quantity += 1;
      } else {
        currentBillItems.push({
          id: itemId,
          name: itemName,
          price: price,
          quantity: 1
        });
      }

      updateBillItemsDisplay();
    };

    window.updateBillItemQuantity = function (itemId, delta) {
      const item = currentBillItems.find(i => i.id === itemId);
      if (!item) return;

      item.quantity += delta;

      if (item.quantity <= 0) {
        currentBillItems = currentBillItems.filter(i => i.id !== itemId);
      }

      updateBillItemsDisplay();
    };

    window.removeBillItem = function (itemId) {
      currentBillItems = currentBillItems.filter(i => i.id !== itemId);
      updateBillItemsDisplay();
    };

    function updateBillItemsDisplay() {
      const listContainer = document.getElementById('selected-items-list');
      const itemsCount = document.getElementById('items-count');
      const totalDisplay = document.getElementById('bill-total');

      if (!listContainer || !itemsCount || !totalDisplay) return;

      if (currentBillItems.length === 0) {
        listContainer.innerHTML = '<div class="text-center text-gray-400 py-8">No items selected</div>';
        itemsCount.textContent = '0 items selected';
        totalDisplay.textContent = formatCurrency(0);
        return;
      }

      const subtotal = currentBillItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const settings = getSettings();
      const tax = subtotal * (settings.taxRate / 100);
      const total = subtotal + tax;

      itemsCount.textContent = `${currentBillItems.length} items selected`;
      totalDisplay.textContent = formatCurrency(total);

      listContainer.innerHTML = currentBillItems.map(item => `
        <div class="flex items-center gap-3 p-3 rounded-lg bg-white border border-gray-200">
          <div class="flex-1">
            <div class="font-semibold">${item.name}</div>
            <div class="text-sm text-gray-600">${formatCurrency(item.price)} √ó ${item.quantity}</div>
          </div>
          <div class="flex items-center gap-2">
            <button type="button" onclick="updateBillItemQuantity('${item.id}', -1)" class="px-2 py-1 rounded border-2 border-gray-300 hover:bg-gray-50">‚àí</button>
            <span class="font-bold w-8 text-center">${item.quantity}</span>
            <button type="button" onclick="updateBillItemQuantity('${item.id}', 1)" class="px-2 py-1 rounded border-2 border-gray-300 hover:bg-gray-50">+</button>
          </div>
          <div class="font-bold" style="color: ${config.primary_color};">${formatCurrency(item.price * item.quantity)}</div>
          <button type="button" onclick="removeBillItem('${item.id}')" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    async function handleCreateBill(e) {
      e.preventDefault();

      if (isSubmitting) {
        showToast('Please wait, saving in progress...', 'info');
        return;
      }
      if (currentBillItems.length === 0) {
        showToast('Please add at least one item', 'error');
        return;
      }
      if (allData.length >= MAX_RECORDS) {
        showToast(`Maximum limit of ${MAX_RECORDS} records reached. Please delete some items first.`, 'error');
        return;
      }

      isSubmitting = true;
      const submitBtn = document.getElementById('save-bill-btn');
      const printBtn = document.getElementById('save-print-bill-btn');

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';
      }
      if (printBtn) {
        printBtn.disabled = true;
      }

      const companyIdEl = document.getElementById('bill-company');
      const employeeIdEl = document.getElementById('bill-employee');
      const dateEl = document.getElementById('bill-date');

      if (!companyIdEl || !employeeIdEl || !dateEl) {
        showToast('Form elements missing', 'error');
        isSubmitting = false;
        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Save'; }
        if (printBtn) printBtn.disabled = false;
        return;
      }

      const companyId = companyIdEl.value;
      const employeeId = employeeIdEl.value;
      const date = dateEl.value;

      const company = getCompanies().find(c => c.__backendId === companyId);
      const employee = getEmployees().find(e => e.__backendId === employeeId);

      if (!company || !employee) {
        showToast('Invalid company or employee selection', 'error');
        isSubmitting = false;
        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Save'; }
        if (printBtn) printBtn.disabled = false;
        return;
      }

      const subtotal = currentBillItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const settings = getSettings();
      const tax = subtotal * (settings.taxRate / 100);
      const total = subtotal + tax;

      const billData = {
        type: 'bill',
        billId: `BILL-${Date.now()}`,
        billNumber: generateBillNumber(),
        date: date,
        companyId: companyId,
        companyName: company.name,
        employeeId: employeeId,
        employeeName: employee.name,
        items: JSON.stringify(currentBillItems),
        subtotal: subtotal,
        tax: tax,
        total: total,
        isPaid: false,
        paidAmount: 0,
        timestamp: Date.now()
      };

      const result = await createRecord(billData);

      if (result) {
        showToast('Bill saved successfully!');
        currentBillItems = [];

        if (currentPage === 'newbill') {
          navigateToPage('dashboard');
        } else {
          closeModal();
        }
      }

      isSubmitting = false;
      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Save'; }
      if (printBtn) printBtn.disabled = false;
    }

    async function handleSaveAndPrintBill(e) {
      if (isSubmitting) {
        showToast('Please wait, saving in progress...', 'info');
        return;
      }
      if (currentBillItems.length === 0) {
        showToast('Please add at least one item', 'error');
        return;
      }
      if (allData.length >= MAX_RECORDS) {
        showToast(`Maximum limit of ${MAX_RECORDS} records reached. Please delete some items first.`, 'error');
        return;
      }

      isSubmitting = true;
      const submitBtn = document.getElementById('save-bill-btn');
      const printBtn = document.getElementById('save-print-bill-btn');
      submitBtn.disabled = true;
      printBtn.disabled = true;
      printBtn.textContent = 'Saving...';

      const companyId = document.getElementById('bill-company').value;
      const employeeId = document.getElementById('bill-employee').value;
      const date = document.getElementById('bill-date').value;

      const company = getCompanies().find(c => c.__backendId === companyId);
      const employee = getEmployees().find(e => e.__backendId === employeeId);

      const subtotal = currentBillItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const settings = getSettings();
      const tax = subtotal * (settings.taxRate / 100);
      const total = subtotal + tax;

      const billData = {
        type: 'bill',
        billId: `BILL-${Date.now()}`,
        billNumber: generateBillNumber(),
        date: date,
        companyId: companyId,
        companyName: company.name,
        employeeId: employeeId,
        employeeName: employee.name,
        items: JSON.stringify(currentBillItems),
        subtotal: subtotal,
        tax: tax,
        total: total,
        isPaid: false,
        paidAmount: 0,
        timestamp: Date.now()
      };

      const result = await createRecord(billData);

      if (result) {
        showToast('Bill saved successfully!');

        setTimeout(() => {
          // Find the newly created bill and print it
          const bills = getBills();
          const newBill = bills[0]; // Most recent bill
          if (newBill) {
            printBill(newBill.__backendId);
          }

          currentBillItems = [];

          if (currentPage === 'newbill') {
            navigateToPage('dashboard');
          } else {
            closeModal();
          }
        }, 500);
      }

      isSubmitting = false;
      submitBtn.disabled = false;
      printBtn.disabled = false;
      printBtn.textContent = 'Save & Print';
    }

    // Companies Page
    function renderCompaniesPage() {
      const companies = getCompanies();
      const baseSize = config.font_size || defaultConfig.font_size;

      return `
        <div class="bg-white rounded-2xl shadow-xl p-8">
          <h2 class="text-3xl font-bold mb-6" style="color: ${config.primary_color}; font-size: ${baseSize * 2}px;">Company Tracking</h2>
          
          <div class="space-y-4">
            ${companies.length > 0 ? companies.map(company => {
        const employees = getEmployees(company.__backendId);
        const bills = getBills({ companyId: company.__backendId });
        const totalAmount = bills.reduce((sum, b) => sum + b.total, 0);
        const paidAmount = bills.reduce((sum, b) => sum + b.paidAmount, 0);
        const pending = totalAmount - paidAmount;

        const month = companyMonthlyMonthById[company.__backendId] || selectedMonth;
        const monthBills = getBills({ companyId: company.__backendId, month });
        const monthTotal = monthBills.reduce((sum, b) => sum + b.total, 0);
        const monthPaid = monthBills.reduce((sum, b) => sum + b.paidAmount, 0);
        const monthDue = monthTotal - monthPaid;

        return `
                <div class="border-2 border-gray-200 rounded-xl overflow-hidden">
                  <div class="p-6 bg-gray-50 cursor-pointer hover:bg-gray-100" onclick="toggleCompanyDetails('${company.__backendId}')">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <h3 class="text-xl font-bold mb-2" style="font-size: ${baseSize * 1.4}px;">${company.name}</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                          <div style="font-size: ${baseSize * 0.9}px;">
                            <span class="text-gray-600">Contact:</span>
                            <span class="font-semibold ml-2">${company.contactPerson || 'N/A'}</span>
                          </div>
                          <div style="font-size: ${baseSize * 0.9}px;">
                            <span class="text-gray-600">Phone:</span>
                            <span class="font-semibold ml-2">${company.phone || 'N/A'}</span>
                          </div>
                          <div style="font-size: ${baseSize * 0.9}px;">
                            <span class="text-gray-600">Employees:</span>
                            <span class="font-semibold ml-2">${employees.length}</span>
                          </div>
                          <div style="font-size: ${baseSize * 0.9}px;">
                            <span class="text-gray-600">Bills:</span>
                            <span class="font-semibold ml-2">${bills.length}</span>
                          </div>
                        </div>
                      </div>
                      <div class="text-right">
                        <div class="text-sm text-gray-600 mb-1" style="font-size: ${baseSize * 0.9}px;">Total Amount</div>
                        <div class="text-2xl font-bold" style="color: ${config.primary_color}; font-size: ${baseSize * 1.6}px;">${formatCurrency(totalAmount)}</div>
                        <div class="text-sm ${pending > 0 ? 'text-red-600' : 'text-green-600'} font-semibold mt-1" style="font-size: ${baseSize * 0.9}px;">
                          ${pending > 0 ? `Pending: ${formatCurrency(pending)}` : 'Fully Paid'}
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div id="company-details-${company.__backendId}" class="hidden p-6 border-t-2 border-gray-200 space-y-6">
                    <div class="rounded-xl bg-gray-50 border-2 border-gray-200 p-5">
                      <div class="flex items-center justify-between gap-4 flex-wrap">
                        <h4 class="font-bold" style="font-size: ${baseSize * 1.1}px;">Monthly Billing</h4>
                        <div class="flex items-center gap-2">
                          <label class="text-sm text-gray-600" style="font-size: ${baseSize * 0.9}px;">Month:</label>
                          <input
                            type="month"
                            value="${month}"
                            onchange="setCompanyMonthlyMonth('${company.__backendId}', this.value)"
                            class="px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
                            style="font-size: ${baseSize * 0.95}px;"
                          />
                          <button type="button" onclick="printCompanyMonthlyBill('${company.__backendId}', '${month}')"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-colors flex items-center gap-2 shadow-md hover:shadow-lg transform active:scale-95"
                            style="font-size: ${baseSize * 0.9}px;">
                            <span>üñ®Ô∏è</span> Print Monthly Bill
                          </button>
                        </div>
                      </div>

                      <div class="grid grid-cols-2 gap-4 mt-4">
                        <div class="p-4 rounded-lg" style="background-color: ${config.primary_color};">
                          <div class="text-white opacity-90 text-sm" style="font-size: ${baseSize * 0.9}px;">Total Amount</div>
                          <div class="text-2xl font-bold text-white mt-1" style="font-size: ${baseSize * 1.5}px;">${formatCurrency(monthTotal)}</div>
                          <div class="text-white opacity-80 text-xs mt-1" style="font-size: ${baseSize * 0.8}px;">${monthBills.length} bills</div>
                        </div>
                        <div class="p-4 rounded-lg ${monthDue > 0 ? 'bg-red-600' : 'bg-green-600'}">
                          <div class="text-white opacity-90 text-sm" style="font-size: ${baseSize * 0.9}px;">Final Amount (Due)</div>
                          <div class="text-2xl font-bold text-white mt-1" style="font-size: ${baseSize * 1.5}px;">${formatCurrency(monthDue)}</div>
                          <div class="text-white opacity-80 text-xs mt-1" style="font-size: ${baseSize * 0.8}px;">Paid: ${formatCurrency(monthPaid)}</div>
                        </div>
                      </div>

                      <div class="mt-5">
                        <div class="font-bold mb-3" style="font-size: ${baseSize}px;">Employees (${employees.length})</div>
                        <div class="space-y-2">
                          ${employees.map(emp => {
          const empMonthBills = getBills({ employeeId: emp.__backendId, month });
          const empTotal = empMonthBills.reduce((sum, b) => sum + b.total, 0);
          const empPaid = empMonthBills.reduce((sum, b) => sum + b.paidAmount, 0);
          const empDue = empTotal - empPaid;

          return `
                              <div class="flex justify-between items-center p-3 rounded-lg bg-white border border-gray-200 hover:shadow-md cursor-pointer" onclick="viewEmployeeDetails('${emp.__backendId}')">
                                <div>
                                  <div class="font-semibold" style="font-size: ${baseSize}px;">${emp.name}</div>
                                  <div class="text-sm text-gray-600" style="font-size: ${baseSize * 0.85}px;">
                                    Total: <span class="font-semibold">${formatCurrency(empTotal)}</span>
                                    <span class="mx-2">‚Ä¢</span>
                                    Final: <span class="font-semibold ${empDue > 0 ? 'text-red-600' : 'text-green-600'}">${formatCurrency(empDue)}</span>
                                  </div>
                                </div>
                                <div class="text-right">
                                  <div class="text-xs text-gray-500" style="font-size: ${baseSize * 0.8}px;">Paid</div>
                                  <div class="font-bold" style="color: ${config.primary_color}; font-size: ${baseSize * 1.05}px;">${formatCurrency(empPaid)}</div>
                                </div>
                              </div>
                            `;
        }).join('') || '<div class="text-center text-gray-400 py-4">No employees added</div>'}
                        </div>
                      </div>
                    </div>

                    <div>
                      <h4 class="font-bold mb-4" style="font-size: ${baseSize * 1.1}px;">All-time Summary (Employees)</h4>
                      <div class="space-y-2">
                        ${employees.map(emp => {
          const empBills = getBills({ employeeId: emp.__backendId });
          const empTotal = empBills.reduce((sum, b) => sum + b.total, 0);
          const empPaid = empBills.reduce((sum, b) => sum + b.paidAmount, 0);

          return `
                            <div class="flex justify-between items-center p-3 rounded-lg bg-white border border-gray-200 hover:shadow-md cursor-pointer" onclick="viewEmployeeDetails('${emp.__backendId}')">
                              <div>
                                <div class="font-semibold" style="font-size: ${baseSize}px;">${emp.name}</div>
                                <div class="text-sm text-gray-600" style="font-size: ${baseSize * 0.85}px;">${emp.phone || 'No phone'}</div>
                              </div>
                              <div class="text-right">
                                <div class="font-bold" style="color: ${config.primary_color}; font-size: ${baseSize * 1.1}px;">${formatCurrency(empTotal)}</div>
                                <div class="text-xs ${(empTotal - empPaid) > 0 ? 'text-red-600' : 'text-green-600'}" style="font-size: ${baseSize * 0.8}px;">
                                  ${(empTotal - empPaid) > 0 ? `Due: ${formatCurrency(empTotal - empPaid)}` : 'Paid'}
                                </div>
                              </div>
                            </div>
                          `;
        }).join('') || '<div class="text-center text-gray-400 py-4">No employees added</div>'}
                      </div>
                    </div>
                  </div>
                </div>
              `;
      }).join('') : `
              <div class="text-center py-12 text-gray-400">
                <div class="text-6xl mb-4">üè¢</div>
                <div class="text-xl" style="font-size: ${baseSize * 1.3}px;">No companies added yet</div>
              </div>
            `}
          </div>
        </div>
      `;
    }

    window.toggleCompanyDetails = function (companyId) {
      const details = document.getElementById(`company-details-${companyId}`);
      if (details) {
        details.classList.toggle('hidden');
      }
    };

    window.setCompanyMonthlyMonth = function (companyId, month) {
      companyMonthlyMonthById[companyId] = month;
      render();
    };

    window.viewEmployeeDetails = function (employeeId) {
      selectedEmployeeId = employeeId;
      filterDateFrom = '';
      filterDateTo = '';
      activeEmployeeTab = 'bills';
      showEmployeeDetailsModal();
    };

    window.printCompanyMonthlyBill = function (companyId, month) {
      const company = getCompanies().find(c => c.__backendId === companyId);
      if (!company) return;

      const employees = getEmployees(companyId);
      const bills = getBills({ companyId, month });
      const settings = getSettings();

      let html = `
        <html>
        <head>
          <title>Monthly Statement - ${company.name} (${month})</title>
          <style>
            body { font-family: 'Inter', sans-serif; padding: 40px; color: #333; }
            .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
            .business-name { font-size: 28px; font-weight: 800; color: #2563EB; margin-bottom: 4px; }
            .business-tagline { font-size: 14px; color: #666; margin-bottom: 20px; }
            .statement-title { font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
            .info-grid { display: grid; grid-template-cols: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
            .info-label { color: #666; font-size: 12px; text-transform: uppercase; font-weight: 600; }
            .info-value { font-size: 16px; font-weight: 600; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th { background: #f8fafc; text-align: left; padding: 12px; border-bottom: 2px solid #e2e8f0; font-size: 13px; text-transform: uppercase; }
            td { padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
            .footer { margin-top: 50px; text-align: center; font-size: 12px; color: #94a3b8; }
            .total-row { font-weight: 800; background: #f1f5f9; }
            .amount { text-align: right; }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="business-name">${settings.businessName || defaultConfig.business_name}</div>
            <div class="business-tagline">${settings.businessTagline || defaultConfig.business_tagline}</div>
            <div class="statement-title">Monthly Company Statement</div>
          </div>
          
          <div class="info-grid">
            <div>
              <div class="info-label">Company Name</div>
              <div class="info-value">${company.name}</div>
            </div>
            <div style="text-align: right;">
              <div class="info-label">Statement Period</div>
              <div class="info-value">${month}</div>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Employee Name</th>
                <th class="amount">Total Billed</th>
                <th class="amount">Total Paid</th>
                <th class="amount">Balance Due</th>
              </tr>
            </thead>
            <tbody>
      `;

      let grandTotal = 0;
      let grandPaid = 0;
      let grandDue = 0;

      employees.forEach(emp => {
        const empMonthBills = getBills({ employeeId: emp.__backendId, month });
        const empTotal = empMonthBills.reduce((sum, b) => sum + b.total, 0);
        const empPaid = empMonthBills.reduce((sum, b) => sum + b.paidAmount, 0);
        const empDue = empTotal - empPaid;

        if (empTotal > 0 || empPaid > 0) {
          grandTotal += empTotal;
          grandPaid += empPaid;
          grandDue += empDue;

          html += `
            <tr>
              <td>${emp.name}</td>
              <td class="amount">${formatCurrency(empTotal)}</td>
              <td class="amount">${formatCurrency(empPaid)}</td>
              <td class="amount" style="color: ${empDue > 0 ? '#dc2626' : '#16a34a'}">${formatCurrency(empDue)}</td>
            </tr>
          `;
        }
      });

      html += `
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td>GRAND TOTAL</td>
                <td class="amount">${formatCurrency(grandTotal)}</td>
                <td class="amount">${formatCurrency(grandPaid)}</td>
                <td class="amount">${formatCurrency(grandDue)}</td>
              </tr>
            </tfoot>
          </table>

            <div class="footer">
              <p>${settings.footerNote || defaultConfig.footer_note}</p>
              <p>Generated on ${new Date().toLocaleString()}</p>
            </div>
        </body>
        </html>
          `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(html);
      printWindow.document.close();
      setTimeout(() => {
        printWindow.print();
      }, 500);
    };

    // Employee Details Modal
    function showEmployeeDetailsModal() {
      const employee = getEmployees().find(e => e.__backendId === selectedEmployeeId);
      if (!employee) return;

      const company = getCompanies().find(c => c.__backendId === employee.companyId);

      const allBills = getBills({ employeeId: selectedEmployeeId });
      const filteredBills = filterDateFrom || filterDateTo
        ? allBills.filter(bill => {
          if (filterDateFrom && bill.date < filterDateFrom) return false;
          if (filterDateTo && bill.date > filterDateTo) return false;
          return true;
        })
        : allBills;

      const payments = getPayments(selectedEmployeeId);
      const filteredPayments = filterDateFrom || filterDateTo
        ? payments.filter(payment => {
          const payDate = payment.paymentDate || payment.date;
          if (filterDateFrom && payDate < filterDateFrom) return false;
          if (filterDateTo && payDate > filterDateTo) return false;
          return true;
        })
        : payments;

      const totalBilled = filteredBills.reduce((sum, b) => sum + b.total, 0);
      const totalPaid = filteredBills.reduce((sum, b) => sum + b.paidAmount, 0);
      const pending = totalBilled - totalPaid;

      const initials = employee.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

      const isFilterActive = filterDateFrom || filterDateTo;
      const filterText = isFilterActive
        ? `Showing results from ${filterDateFrom ? new Date(filterDateFrom).toLocaleDateString('en-IN') : 'beginning'} to ${filterDateTo ? new Date(filterDateTo).toLocaleDateString('en-IN') : 'today'} `
        : '';

      const content = `
            <div class="p-8 relative">
          <button onclick="closeModal()" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600 text-2xl font-bold transition-colors">
            √ó
          </button>

          <div class="flex justify-between items-start mb-8">
            <div class="flex items-start gap-4">
              <div class="w-16 h-16 rounded-full flex items-center justify-center text-white text-xl font-bold flex-shrink-0" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #764ba2 100%);">
                ${initials}
              </div>
              
              <div>
                <h2 class="text-3xl font-bold mb-1" style="color: ${config.primary_color};">${employee.name}</h2>
                <p class="text-gray-500 text-lg mb-2">${company ? company.name : 'Unknown Company'}</p>
                <p class="text-sm text-gray-400">${employee.phone || 'No phone'} ${employee.email ? '‚Ä¢ ' + employee.email : ''}</p>
              </div>
            </div>
            
            <button onclick="downloadEmployeeExcel('${selectedEmployeeId}')" ${filteredBills.length === 0 ? 'disabled' : ''} class="px-6 py-3 rounded-lg text-white font-semibold ${filteredBills.length === 0 ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 hover:shadow-lg transition-all'}" title="Download bills & payments as Excel">
              üì• Download Excel
              <div class="text-xs opacity-90 mt-0.5">Includes bills & payments</div>
            </button>
          </div>

          <div class="grid grid-cols-3 gap-5 mb-8">
            <div class="p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow" style="background-color: ${config.primary_color};">
              <div class="flex items-center gap-2 text-white opacity-90 text-sm mb-2">
                <span class="text-lg">üìÑ</span>
                <span>Total Billed</span>
              </div>
              <div class="text-3xl font-bold text-white">${formatCurrency(totalBilled)}</div>
            </div>
            
            <div class="p-5 rounded-xl bg-green-600 shadow-sm hover:shadow-md transition-shadow">
              <div class="flex items-center gap-2 text-white opacity-90 text-sm mb-2">
                <span class="text-lg">‚úî</span>
                <span>Total Paid</span>
              </div>
              <div class="text-3xl font-bold text-white">${formatCurrency(totalPaid)}</div>
            </div>
            
            <div class="p-6 rounded-xl ${pending > 0 ? 'bg-red-600 shadow-lg scale-105' : 'bg-gray-400 shadow-sm'} hover:shadow-xl transition-all">
              <div class="flex items-center gap-2 text-white opacity-90 text-sm mb-2">
                <span class="text-lg">‚è≥</span>
                <span class="font-semibold">Pending</span>
              </div>
              <div class="text-4xl font-bold text-white">${formatCurrency(pending)}</div>
            </div>
          </div>

          <div class="mb-8 p-5 rounded-xl ${isFilterActive ? 'bg-blue-50 border-2 border-blue-300' : 'bg-gray-50'} transition-all">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold text-lg">Filter by Date</h3>
              ${isFilterActive ? `<span class="text-sm text-blue-600 font-medium">üîç ${filterText}</span>` : ''}
            </div>
            
            <div class="grid grid-cols-4 gap-2 mb-4">
              <button type="button" onclick="quickFilterEmployee('today')" class="py-2 px-3 rounded-lg bg-white border-2 border-gray-300 hover:border-blue-500 hover:bg-blue-50 font-medium text-sm transition-all">
                üìÖ Today
              </button>
              <button type="button" onclick="quickFilterEmployee('week')" class="py-2 px-3 rounded-lg bg-white border-2 border-gray-300 hover:border-blue-500 hover:bg-blue-50 font-medium text-sm transition-all">
                üìÜ This Week
              </button>
              <button type="button" onclick="quickFilterEmployee('month')" class="py-2 px-3 rounded-lg bg-white border-2 border-gray-300 hover:border-blue-500 hover:bg-blue-50 font-medium text-sm transition-all">
                üìä This Month
              </button>
              <button type="button" onclick="quickFilterEmployee('lastmonth')" class="py-2 px-3 rounded-lg bg-white border-2 border-gray-300 hover:border-blue-500 hover:bg-blue-50 font-medium text-sm transition-all">
                üìâ Last Month
              </button>
            </div>
            
            <div class="grid grid-cols-4 gap-3">
              <div>
                <label for="filter-date-from" class="block text-sm mb-1 font-medium">From Date</label>
                <input type="date" id="filter-date-from" value="${filterDateFrom}" class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition-all">
              </div>
              <div>
                <label for="filter-date-to" class="block text-sm mb-1 font-medium">To Date</label>
                <input type="date" id="filter-date-to" value="${filterDateTo}" class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition-all">
              </div>
              <div class="flex items-end">
                <button type="button" onclick="applyEmployeeDateFilter()" class="w-full py-2 rounded-lg text-white font-semibold hover:shadow-lg transition-all" style="background-color: ${config.primary_color};">
                  Apply Filter
                </button>
              </div>
              <div class="flex items-end">
                <button type="button" onclick="clearEmployeeDateFilter()" class="w-full py-2 rounded-lg border-2 border-gray-300 font-semibold hover:bg-gray-100 transition-all">
                  Clear
                </button>
              </div>
            </div>
          </div>

          <div class="flex border-b-2 border-gray-200 mb-8 items-center justify-between">
            <div class="flex">
              <button type="button" onclick="switchEmployeeTab('bills')" class="tab-btn px-6 py-3 flex items-center gap-2 ${activeEmployeeTab === 'bills' ? 'active' : 'text-gray-600 hover:text-gray-800'}">
                üìã Bills 
                <span class="px-2 py-0.5 rounded-full text-xs font-bold ${activeEmployeeTab === 'bills' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}">${filteredBills.length}</span>
              </button>
              <button type="button" onclick="switchEmployeeTab('payments')" class="tab-btn px-6 py-3 flex items-center gap-2 ${activeEmployeeTab === 'payments' ? 'active' : 'text-gray-600 hover:text-gray-800'}">
                üí∞ Transactions 
                <span class="px-2 py-0.5 rounded-full text-xs font-bold ${activeEmployeeTab === 'payments' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}">${filteredPayments.length}</span>
              </button>
            </div>
            <div class="flex gap-2">
              <button type="button" onclick="printAllFilteredBills('${selectedEmployeeId}')" ${filteredBills.length === 0 ? 'disabled' : ''} class="px-4 py-2 rounded-lg text-white font-semibold ${filteredBills.length === 0 ? 'bg-gray-400 cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-700'} transition-all text-sm" title="Print all filtered bills">
                üñ® Print All
              </button>
            </div>
          </div>

          <div id="bills-tab" class="${activeEmployeeTab === 'bills' ? '' : 'hidden'}">
            <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
              ${filteredBills.length > 0 ? filteredBills.map(bill => {
        const items = JSON.parse(bill.items);
        const isPaid = bill.paidAmount >= bill.total;
        const dueAmount = bill.total - bill.paidAmount;
        const itemSummary = items.slice(0, 2).map(i => i.name).join(', ') + (items.length > 2 ? ` +${items.length - 2} more` : '');

        return `
                  <div class="border ${isPaid ? 'border-green-200 bg-green-50' : 'border-gray-200 bg-white'} rounded-xl p-5 hover:shadow-lg transition-all duration-200">
                    <div class="flex justify-between items-start mb-4">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                          <span class="font-bold text-xl">Bill #${bill.billNumber}</span>
                          <span class="text-sm text-gray-500">${new Date(bill.date).toLocaleDateString('en-IN')}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">${items.length} item${items.length > 1 ? 's' : ''}: ${itemSummary}</div>
                      </div>
                      <div class="text-right">
                        ${isPaid ? `
                          <div class="text-3xl font-bold text-green-600 mb-1">${formatCurrency(bill.total)}</div>
                          <div class="text-sm text-green-600 font-semibold flex items-center justify-end gap-1">
                            <span>‚úì</span> Fully Paid
                          </div>
                        ` : `
                          <div class="text-3xl font-bold mb-1" style="color: ${config.primary_color};">${formatCurrency(bill.total)}</div>
                          <div class="text-lg text-red-600 font-bold">Due: ${formatCurrency(dueAmount)}</div>
                        `}
                      </div>
                    </div>
                    <div class="flex gap-2">
                      <button type="button" onclick="viewBillDetails('${bill.__backendId}')" class="flex-1 py-2 rounded-lg border border-gray-300 font-medium hover:bg-gray-50 transition-all text-sm">
                        üëÅ View
                      </button>
                      <button type="button" onclick="confirmEditBill('${bill.__backendId}')" class="flex-1 py-2 rounded-lg border border-orange-300 text-orange-600 font-medium hover:bg-orange-50 transition-all text-sm" title="Edit bill details">
                        ‚úèÔ∏è Edit
                      </button>
                      <button type="button" onclick="printBill('${bill.__backendId}')" class="flex-1 py-2 rounded-lg text-white font-semibold hover:shadow-lg transition-all text-sm" style="background-color: ${config.primary_color};">
                        üñ® Print
                      </button>
                      ${!isPaid ? `
                        <button type="button" onclick="recordPayment('${bill.__backendId}')" class="flex-1 py-2 rounded-lg bg-green-600 text-white font-bold hover:bg-green-700 hover:shadow-lg transition-all text-sm">
                          üí≥ Pay
                        </button>
                        <button type="button" onclick="recordPaymentAndPrint('${bill.__backendId}')" class="flex-1 py-2 rounded-lg bg-purple-600 text-white font-bold hover:bg-purple-700 hover:shadow-lg transition-all text-sm" title="Record payment and print receipt">
                          üí≥üñ® Pay & Print
                        </button>
                      ` : ''}
                    </div>
                  </div>
                `;
      }).join('') : `
                <div class="text-center py-16 text-gray-400">
                  <div class="text-7xl mb-4">üìã</div>
                  <div class="text-2xl font-semibold mb-2">No bills found</div>
                  <div class="text-sm">Try adjusting your date filter</div>
                </div>
              `}
            </div>
          </div>

          <div id="payments-tab" class="${activeEmployeeTab === 'payments' ? '' : 'hidden'}">
            <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
              ${filteredPayments.length > 0 ? filteredPayments.map(payment => `
                <div class="border-2 border-green-200 bg-green-50 rounded-xl p-5 hover:shadow-lg transition-all duration-200">
                  <div class="flex justify-between items-center">
                    <div>
                      <div class="font-bold text-lg mb-1">ÔøΩÔøΩÔøΩÔøΩ Payment Received</div>
                      <div class="text-sm text-gray-600">${new Date(payment.paymentDate || payment.date).toLocaleDateString('en-IN')}</div>
                      <div class="text-xs text-gray-500 mt-2">Received by: <span class="font-semibold">${payment.paymentBy}</span></div>
                    </div>
                    <div class="text-3xl font-bold text-green-600">${formatCurrency(payment.paidAmount)}</div>
                  </div>
                </div>
              `).join('') : `
                <div class="text-center py-16 text-gray-400">
                  <div class="text-7xl mb-4">üí∞</div>
                  <div class="text-2xl font-semibold mb-2">No transactions found</div>
                  <div class="text-sm">Payment history will appear here</div>
                </div>
              `}
            </div>
          </div>

          <button type="button" onclick="closeModal()" class="w-full mt-8 py-3 rounded-lg border-2 border-gray-300 font-semibold hover:bg-gray-50 transition-all">
            Close
          </button>
        </div>
            `;

      openModal(content);
    }

    window.switchEmployeeTab = function (tab) {
      activeEmployeeTab = tab;
      showEmployeeDetailsModal();
    };

    window.applyEmployeeDateFilter = function () {
      filterDateFrom = document.getElementById('filter-date-from').value;
      filterDateTo = document.getElementById('filter-date-to').value;
      showEmployeeDetailsModal();
    };

    window.clearEmployeeDateFilter = function () {
      filterDateFrom = '';
      filterDateTo = '';
      showEmployeeDetailsModal();
    };

    window.quickFilterEmployee = function (period) {
      const today = new Date();
      const formatDate = (date) => date.toISOString().split('T')[0];

      switch (period) {
        case 'today':
          filterDateFrom = formatDate(today);
          filterDateTo = formatDate(today);
          break;
        case 'week':
          const weekStart = new Date(today);
          weekStart.setDate(today.getDate() - today.getDay());
          filterDateFrom = formatDate(weekStart);
          filterDateTo = formatDate(today);
          break;
        case 'month':
          const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
          filterDateFrom = formatDate(monthStart);
          filterDateTo = formatDate(today);
          break;
        case 'lastmonth':
          const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
          filterDateFrom = formatDate(lastMonthStart);
          filterDateTo = formatDate(lastMonthEnd);
          break;
      }

      showEmployeeDetailsModal();
    };

    window.recordPaymentAndPrint = function (billId) {
      const bill = getBills().find(b => b.__backendId === billId);
      if (!bill) return;

      const pending = bill.total - bill.paidAmount;

      const content = `
            <div class="p-8">
          <h2 class="text-3xl font-bold mb-6" style="color: ${config.primary_color};">Record Payment & Print</h2>
          
          <div class="mb-6 p-4 rounded-lg bg-gray-50">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <div class="text-sm text-gray-600">Bill Number</div>
                <div class="font-bold">#${bill.billNumber}</div>
              </div>
              <div>
                <div class="text-sm text-gray-600">Employee</div>
                <div class="font-bold">${bill.employeeName}</div>
              </div>
              <div>
                <div class="text-sm text-gray-600">Total Amount</div>
                <div class="font-bold">${formatCurrency(bill.total)}</div>
              </div>
              <div>
                <div class="text-sm text-gray-600">Pending</div>
                <div class="font-bold text-red-600">${formatCurrency(pending)}</div>
              </div>
            </div>
          </div>

          <form id="payment-print-form" class="space-y-6">
            <div>
              <label for="payment-print-amount" class="block mb-2 font-semibold">Payment Amount *</label>
              <input type="number" id="payment-print-amount" required step="0.01" max="${pending}" value="${pending}" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none">
            </div>

            <div>
              <label for="payment-print-name" class="block mb-2 font-semibold">Received By (Your Name) *</label>
              <input type="text" id="payment-print-name" required placeholder="Enter your name" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none">
            </div>

            <div>
              <label for="payment-date-print" class="block mb-2 font-semibold">Payment Date *</label>
              <input type="date" id="payment-date-print" required value="${new Date().toISOString().split('T')[0]}" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none">
            </div>

            <input type="hidden" id="bill-id-print" value="${billId}">

            <div class="flex gap-3">
              <button type="button" onclick="closeModal()" class="flex-1 py-3 rounded-lg border-2 border-gray-300 font-semibold hover:bg-gray-50">
                Cancel
              </button>
              <button type="submit" id="save-payment-print-btn" class="flex-1 py-3 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700">
                Save & Print
              </button>
            </div>
          </form>
        </div>
            `;

      openModal(content);
      document.getElementById('payment-print-form').addEventListener('submit', handleSavePaymentAndPrint);
    };

    async function handleSavePaymentAndPrint(e) {
      e.preventDefault();

      if (isSubmitting) {
        showToast('Please wait, saving in progress...', 'info');
        return;
      }

      const paymentBy = document.getElementById('payment-print-name').value.trim();
      if (!paymentBy) {
        showToast('Please enter your name', 'error');
        return;
      }

      if (allData.length >= MAX_RECORDS) {
        showToast(`Maximum limit of ${MAX_RECORDS} records reached.Please delete some items first.`, 'error');
        return;
      }

      isSubmitting = true;
      const submitBtn = document.getElementById('save-payment-print-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      const billId = document.getElementById('bill-id-print').value;
      const amount = parseFloat(document.getElementById('payment-print-amount').value);
      const paymentDate = document.getElementById('payment-date-print').value;

      const bill = allData.find(item => item.__backendId === billId);
      if (!bill) {
        showToast('Bill not found', 'error');
        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save & Print';
        return;
      }

      // Update bill with payment
      const updatedBill = {
        ...bill,
        paidAmount: bill.paidAmount + amount,
        isPaid: (bill.paidAmount + amount) >= bill.total
      };

      await updateRecord(updatedBill);

      // Create payment record
      await createRecord({
        type: 'payment',
        billId: billId,
        employeeId: bill.employeeId,
        employeeName: bill.employeeName,
        companyId: bill.companyId,
        companyName: bill.companyName,
        paidAmount: amount,
        paymentDate: paymentDate,
        paymentBy: paymentBy,
        paymentType: 'staff',
        timestamp: Date.now()
      });

      showToast('Payment recorded successfully!');

      setTimeout(() => {
        printBill(billId);
        closeModal();

        if (selectedEmployeeId) {
          setTimeout(() => showEmployeeDetailsModal(), 500);
        }
      }, 500);

      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save & Print';
    }

    window.printAllFilteredBills = function (employeeId) {
      const employee = getEmployees().find(e => e.__backendId === employeeId);
      if (!employee) return;

      const allBills = getBills({ employeeId: employeeId });
      const filteredBills = filterDateFrom || filterDateTo
        ? allBills.filter(bill => {
          if (filterDateFrom && bill.date < filterDateFrom) return false;
          if (filterDateTo && bill.date > filterDateTo) return false;
          return true;
        })
        : allBills;

      if (filteredBills.length === 0) {
        showToast('No bills to print', 'error');
        return;
      }

      const settings = getSettings();
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const company = getCompanies().find(c => c.__backendId === employee.companyId);

      const printArea = document.getElementById('print-area');

      let allBillsHTML = '';

      filteredBills.forEach((bill, index) => {
        const items = JSON.parse(bill.items);

        allBillsHTML += `
            <div style="max-width: 800px; margin: 0 auto; padding: 40px; font-family: Arial, sans-serif; background: #fff; ${index > 0 ? 'page-break-before: always;' : ''}">
            <div style="text-align: center; border-bottom: 3px solid ${primaryColor}; padding-bottom: 20px; margin-bottom: 30px;">
              <h1 style="margin: 0; font-size: 32px; font-weight: bold; color: #1a1a1a;">${settings.businessName}</h1>
              ${settings.businessTagline ? `<p style="margin: 8px 0; font-size: 14px; color: #666;">${settings.businessTagline}</p>` : ''}
              ${settings.businessAddress ? `<p style="margin: 5px 0; font-size: 12px; color: #666;">${settings.businessAddress}</p>` : ''}
              <div style="margin-top: 8px; font-size: 12px; color: #666;">
                ${settings.businessPhone ? `Phone: ${settings.businessPhone}` : ''}
                ${settings.businessPhone && settings.gstNumber ? ' | ' : ''}
                ${settings.gstNumber ? `GST: ${settings.gstNumber}` : ''}
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; background: #f9fafb; padding: 20px; border-radius: 8px;">
              <div>
                <p style="margin: 0 0 8px 0; font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Bill Number</p>
                <p style="margin: 0; font-size: 16px; font-weight: bold; color: #1a1a1a;">#${bill.billNumber}</p>
              </div>
              <div style="text-align: right;">
                <p style="margin: 0 0 8px 0; font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Bill Date</p>
                <p style="margin: 0; font-size: 16px; font-weight: bold; color: #1a1a1a;">${new Date(bill.date).toLocaleDateString('en-IN')}</p>
              </div>
              <div>
                <p style="margin: 0 0 8px 0; font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Company Name</p>
                <p style="margin: 0; font-size: 16px; font-weight: bold; color: #1a1a1a;">${bill.companyName}</p>
              </div>
              <div style="text-align: right;">
                <p style="margin: 0 0 8px 0; font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Employee Name</p>
                <p style="margin: 0; font-size: 16px; font-weight: bold; color: #1a1a1a;">${bill.employeeName}</p>
              </div>
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
              <thead>
                <tr style="background: ${primaryColor}; color: white;">
                  <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600;">Item Name</th>
                  <th style="padding: 12px; text-align: center; font-size: 13px; font-weight: 600;">Quantity</th>
                  <th style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600;">Rate (‚Çπ)</th>
                  <th style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600;">Amount (‚Çπ)</th>
                </tr>
              </thead>
              <tbody>
                ${items.map((item, idx) => `
                  <tr style="border-bottom: 1px solid #e5e7eb; background: ${idx % 2 === 0 ? '#fff' : '#f9fafb'};">
                    <td style="padding: 12px; font-size: 14px; color: #1a1a1a;">${item.name}</td>
                    <td style="padding: 12px; text-align: center; font-size: 14px; color: #1a1a1a;">${item.quantity}</td>
                    <td style="padding: 12px; text-align: right; font-size: 14px; color: #1a1a1a;">ÔøΩÔøΩ${item.price.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: right; font-size: 14px; font-weight: 600; color: #1a1a1a;">‚Çπ${(item.price * item.quantity).toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>

            <div style="background: ${primaryColor}; padding: 20px; border-radius: 8px; text-align: right; margin-bottom: 40px;">
              <p style="margin: 0; font-size: 24px; font-weight: bold; color: white;">Total Amount: ‚Çπ${bill.total.toFixed(2)}</p>
            </div>

            <div class="footer-container" style="text-align: center; padding-top: 40px; border-top: 2px solid #e5e7eb;">
              ${settings.thankYouMessage ? `<p style="margin: 0 0 10px 0; font-size: 16px; font-weight: 600; color: #1a1a1a;">${settings.thankYouMessage}</p>` : ''}
              ${settings.footerNote ? `<p style="margin: 0; font-size: 12px; color: #6b7280;">${settings.footerNote}</p>` : ''}
            </div>
          </div>
            `;
      });

      printArea.innerHTML = allBillsHTML;
      printArea.style.display = 'block';
      window.print();
      printArea.style.display = 'none';

      showToast(`Printing ${filteredBills.length} bills...`, 'success');
    };

    window.confirmEditBill = function (billId) {
      const bill = getBills().find(b => b.__backendId === billId);
      if (!bill) return;

      if (bill.paidAmount > 0) {
        const content = `
      <div class="p-8 text-center">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <h2 class="text-2xl font-bold mb-4" style="color: ${config.primary_color};">Edit Bill with Payment?</h2>
            <p class="text-gray-600 mb-6">This bill has received partial payment of <span class="font-bold">${formatCurrency(bill.paidAmount)}</span>. Editing it may affect balance records.</p>
            
            <div class="flex gap-3">
              <button type="button" onclick="closeModal()" class="flex-1 py-3 rounded-lg border-2 border-gray-300 font-semibold hover:bg-gray-50">
                Cancel
              </button>
              <button type="button" onclick="closeModal(); editBill('${billId}')" class="flex-1 py-3 rounded-lg text-white font-semibold" style="background-color: ${config.primary_color};">
                Continue Editing
              </button>
            </div>
          </div>
        `;
        openModal(content);
      } else {
        editBill(billId);
      }
    };

    window.downloadEmployeeExcel = function (employeeId) {
      const employee = getEmployees().find(e => e.__backendId === employeeId);
      const bills = getBills({ employeeId: employeeId });

      let csv = 'Bill Number,Date,Items,Quantity,Subtotal,Tax,Total,Paid Amount,Pending\n';

      bills.forEach(bill => {
        const items = JSON.parse(bill.items);
        const itemsStr = items.map(i => `${i.name}(${i.quantity})`).join('; ');
        const totalQty = items.reduce((sum, i) => sum + i.quantity, 0);
        const pending = bill.total - bill.paidAmount;

        csv += `${bill.billNumber}, "${new Date(bill.date).toLocaleDateString()}", "${itemsStr}", ${totalQty}, ${bill.subtotal.toFixed(2)}, ${bill.tax.toFixed(2)}, ${bill.total.toFixed(2)}, ${bill.paidAmount.toFixed(2)}, ${pending.toFixed(2)}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${employee.name}_bills_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();

      showToast('Excel file downloaded!');
    };

    function recordPayment(billId) {
      const bill = getBills().find(b => b.__backendId === billId);
      if (!bill) return;

      const pending = bill.total - bill.paidAmount;

      const content = `
      <div class="p-8">
          <h2 class="text-3xl font-bold mb-6" style="color: ${config.primary_color};">Record Payment</h2>
          
          <div class="mb-6 p-4 rounded-lg bg-gray-50">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <div class="text-sm text-gray-600">Bill Number</div>
                <div class="font-bold">#${bill.billNumber}</div>
              </div>
              <div>
                <div class="text-sm text-gray-600">Employee</div>
                <div class="font-bold">${bill.employeeName}</div>
              </div>
              <div>
                <div class="text-sm text-gray-600">Total Amount</div>
                <div class="font-bold">${formatCurrency(bill.total)}</div>
              </div>
              <div>
                <div class="text-sm text-gray-600">Pending</div>
                <div class="font-bold text-red-600">${formatCurrency(pending)}</div>
              </div>
            </div>
          </div>

          <form id="payment-form" class="space-y-6">
            <div>
              <label for="payment-amount" class="block mb-2 font-semibold">Payment Amount *</label>
              <input type="number" id="payment-amount" required step="0.01" max="${pending}" value="${pending}" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none">
            </div>

            <div>
              <label for="payment-name" class="block mb-2 font-semibold">Received By (Your Name) *</label>
              <input type="text" id="payment-name" required placeholder="Enter your name" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none">
            </div>

            <div>
              <label for="payment-date" class="block mb-2 font-semibold">Payment Date *</label>
              <input type="date" id="payment-date" required value="${new Date().toISOString().split('T')[0]}" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none">
            </div>

            <input type="hidden" id="bill-id" value="${billId}">

            <div class="flex gap-3">
              <button type="button" onclick="closeModal()" class="flex-1 py-3 rounded-lg border-2 border-gray-300 font-semibold hover:bg-gray-50">
                Cancel
              </button>
              <button type="submit" id="save-payment-btn" class="flex-1 py-3 rounded-lg text-white font-semibold" style="background-color: ${config.primary_color};">
                Save Payment
              </button>
            </div>
          </form>
        </div>
        `;

      openModal(content);
      document.getElementById('payment-form').addEventListener('submit', handleSavePayment);
    }

    async function handleSavePayment(e) {
      e.preventDefault();

      if (isSubmitting) {
        showToast('Please wait, saving in progress...', 'info');
        return;
      }

      const paymentBy = document.getElementById('payment-name').value.trim();
      if (!paymentBy) {
        showToast('Please enter your name', 'error');
        return;
      }

      if (allData.length >= MAX_RECORDS) {
        showToast(`Maximum limit of ${MAX_RECORDS} records reached.Please delete some items first.`, 'error');
        return;
      }

      isSubmitting = true;
      const submitBtn = document.getElementById('save-payment-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      const billId = document.getElementById('bill-id').value;
      const amount = parseFloat(document.getElementById('payment-amount').value);
      const paymentDate = document.getElementById('payment-date').value;

      const bill = allData.find(item => item.__backendId === billId);
      if (!bill) {
        showToast('Bill not found', 'error');
        isSubmitting = false;
        return;
      }

      // Update bill with payment
      const updatedBill = {
        ...bill,
        paidAmount: bill.paidAmount + amount,
        isPaid: (bill.paidAmount + amount) >= bill.total
      };

      await updateRecord(updatedBill);

      // Create payment record
      await createRecord({
        type: 'payment',
        billId: billId,
        employeeId: bill.employeeId,
        employeeName: bill.employeeName,
        companyId: bill.companyId,
        companyName: bill.companyName,
        paidAmount: amount,
        paymentDate: paymentDate,
        paymentBy: paymentBy,
        paymentType: 'staff',
        timestamp: Date.now()
      });

      showToast('Payment recorded successfully!');
      closeModal();

      if (selectedEmployeeId) {
        setTimeout(() => showEmployeeDetailsModal(), 300);
      }

      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save Payment';
    }

    window.editBill = function (billId) {
      editingBillId = billId;
      const bill = getBills().find(b => b.__backendId === billId);
      if (!bill) return;

      currentBillItems = JSON.parse(bill.items);

      const content = `
      <div class="p-8">
          <h2 class="text-3xl font-bold mb-6" style="color: ${config.primary_color};">Edit Bill #${bill.billNumber}</h2>
          
          <div class="mb-6 p-4 rounded-lg bg-gray-50">
            <div class="grid grid-cols-3 gap-4 text-sm">
              <div>
                <span class="text-gray-600">Company:</span>
                <span class="font-semibold ml-2">${bill.companyName}</span>
              </div>
              <div>
                <span class="text-gray-600">Employee:</span>
                <span class="font-semibold ml-2">${bill.employeeName}</span>
              </div>
              <div>
                <span class="text-gray-600">Date:</span>
                <span class="font-semibold ml-2">${new Date(bill.date).toLocaleDateString('en-IN')}</span>
              </div>
            </div>
          </div>

          <form id="edit-bill-form">
            <div>
              <label class="block mb-2 font-semibold">Edit Items</label>
              <div id="edit-items-list" class="space-y-2 max-h-96 overflow-y-auto p-4 border-2 border-gray-200 rounded-lg bg-gray-50">
                <!-- Items will be loaded here -->
              </div>
            </div>

            <div class="mt-6 flex items-center justify-between p-4 rounded-lg" style="background-color: ${config.primary_color};">
              <span class="text-white font-bold text-xl">Updated Total:</span>
              <span id="edit-bill-total" class="text-white font-bold text-3xl"></span>
            </div>

            <div class="flex gap-3 mt-6">
              <button type="button" onclick="closeModal(); editingBillId = null; currentBillItems = [];" class="flex-1 py-3 rounded-lg border-2 border-gray-300 font-semibold hover:bg-gray-50">
                Cancel
              </button>
              <button type="submit" id="update-bill-btn" class="flex-1 py-3 rounded-lg text-white font-semibold" style="background-color: ${config.primary_color};">
                Update Bill
              </button>
            </div>
          </form>
        </div>
        `;

      openModal(content);
      updateEditItemsDisplay();
      document.getElementById('edit-bill-form').addEventListener('submit', handleUpdateBill);
    };

    function updateEditItemsDisplay() {
      const listContainer = document.getElementById('edit-items-list');
      const totalDisplay = document.getElementById('edit-bill-total');

      const subtotal = currentBillItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const settings = getSettings();
      const tax = subtotal * (settings.taxRate / 100);
      const total = subtotal + tax;

      totalDisplay.textContent = formatCurrency(total);

      listContainer.innerHTML = currentBillItems.map(item => `
        <div class="flex items-center gap-3 p-3 rounded-lg bg-white border border-gray-200">
          <div class="flex-1">
            <div class="font-semibold">${item.name}</div>
            <div class="flex gap-4 mt-2">
              <div>
                <label for="qty-${item.id}" class="text-xs text-gray-600">Quantity</label>
                <input type="number" id="qty-${item.id}" value="${item.quantity}" min="1" onchange="updateEditItemQuantity('${item.id}', 'quantity', this.value)" class="w-20 px-2 py-1 rounded border-2 border-gray-300 focus:border-blue-500 focus:outline-none">
              </div>
              <div>
                <label for="price-${item.id}" class="text-xs text-gray-600">Price</label>
                <input type="number" id="price-${item.id}" value="${item.price}" min="0" step="0.01" onchange="updateEditItemQuantity('${item.id}', 'price', this.value)" class="w-24 px-2 py-1 rounded border-2 border-gray-300 focus:border-blue-500 focus:outline-none">
              </div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-bold text-lg" style="color: ${config.primary_color};">${formatCurrency(item.price * item.quantity)}</div>
          </div>
          <button type="button" onclick="removeBillItem('${item.id}'); updateEditItemsDisplay();" class="text-red-500 hover:text-red-700 text-xl">üóëÔ∏è</button>
        </div>
        `).join('');
    }

    window.updateEditItemQuantity = function (itemId, field, value) {
      const item = currentBillItems.find(i => i.id === itemId);
      if (!item) return;

      if (field === 'quantity') {
        item.quantity = parseInt(value) || 1;
      } else if (field === 'price') {
        item.price = parseFloat(value) || 0;
      }

      updateEditItemsDisplay();
    };

    async function handleUpdateBill(e) {
      e.preventDefault();

      if (isSubmitting) return;

      isSubmitting = true;
      const submitBtn = document.getElementById('update-bill-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Updating...';

      const bill = allData.find(item => item.__backendId === editingBillId);
      if (!bill) {
        showToast('Bill not found', 'error');
        isSubmitting = false;
        return;
      }

      const subtotal = currentBillItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const settings = getSettings();
      const tax = subtotal * (settings.taxRate / 100);
      const total = subtotal + tax;

      const updatedBill = {
        ...bill,
        items: JSON.stringify(currentBillItems),
        subtotal: subtotal,
        tax: tax,
        total: total,
        isPaid: bill.paidAmount >= total
      };

      await updateRecord(updatedBill);
      showToast('Bill updated successfully!');
      editingBillId = null;
      currentBillItems = [];
      closeModal();

      if (selectedEmployeeId) {
        setTimeout(() => showEmployeeDetailsModal(), 300);
      }

      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.textContent = 'Update Bill';
    }

    window.printBill = function (billId) {
      const bill = getBills().find(b => b.__backendId === billId);
      if (!bill) return;

      const settings = getSettings();
      const items = JSON.parse(bill.items);

      const printerType = settings.printerType || 'A4';

      if (printerType === '80mm') {
        print80mmReceipt(bill, settings, items);
      } else {
        printA4Receipt(bill, settings, items);
      }
    };

    function printA4Receipt(bill, settings, items) {
      const printArea = document.getElementById('print-area');
      const primaryColor = config.primary_color || defaultConfig.primary_color;

      printArea.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto; padding: 40px; font-family: Arial, sans-serif; background: #fff;">
          <div style="text-align: center; border-bottom: 3px solid ${primaryColor}; padding-bottom: 20px; margin-bottom: 30px;">
            <h1 style="margin: 0; font-size: 32px; font-weight: bold; color: #1a1a1a;">${settings.businessName}</h1>
            ${settings.businessTagline ? `<p style="margin: 8px 0; font-size: 14px; color: #666;">${settings.businessTagline}</p>` : ''}
            ${settings.businessAddress ? `<p style="margin: 5px 0; font-size: 12px; color: #666;">${settings.businessAddress}</p>` : ''}
            <div style="margin-top: 8px; font-size: 12px; color: #666;">
              ${settings.businessPhone ? `Phone: ${settings.businessPhone}` : ''}
              ${settings.businessPhone && settings.gstNumber ? ' | ' : ''}
              ${settings.gstNumber ? `GST: ${settings.gstNumber}` : ''}
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; background: #f9fafb; padding: 20px; border-radius: 8px;">
            <div>
              <p style="margin: 0 0 8px 0; font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Bill Number</p>
              <p style="margin: 0; font-size: 16px; font-weight: bold; color: #1a1a1a;">#${bill.billNumber}</p>
            </div>
            <div style="text-align: right;">
              <p style="margin: 0 0 8px 0; font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Bill Date</p>
              <p style="margin: 0; font-size: 16px; font-weight: bold; color: #1a1a1a;">${new Date(bill.date).toLocaleDateString('en-IN')}</p>
            </div>
            <div>
              <p style="margin: 0 0 8px 0; font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Company Name</p>
              <p style="margin: 0; font-size: 16px; font-weight: bold; color: #1a1a1a;">${bill.companyName}</p>
            </div>
            <div style="text-align: right;">
              <p style="margin: 0 0 8px 0; font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Employee Name</p>
              <p style="margin: 0; font-size: 16px; font-weight: bold; color: #1a1a1a;">${bill.employeeName}</p>
            </div>
          </div>

          <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
            <thead>
              <tr style="background: ${primaryColor}; color: white;">
                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600;">Item Name</th>
                <th style="padding: 12px; text-align: center; font-size: 13px; font-weight: 600;">Quantity</th>
                <th style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600;">Rate (‚Çπ)</th>
                <th style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600;">Amount (‚Çπ)</th>
              </tr>
            </thead>
            <tbody>
              ${items.map((item, index) => `
                <tr style="border-bottom: 1px solid #e5e7eb; background: ${index % 2 === 0 ? '#fff' : '#f9fafb'};">
                  <td style="padding: 12px; font-size: 14px; color: #1a1a1a;">${item.name}</td>
                  <td style="padding: 12px; text-align: center; font-size: 14px; color: #1a1a1a;">${item.quantity}</td>
                  <td style="padding: 12px; text-align: right; font-size: 14px; color: #1a1a1a;">‚Çπ${item.price.toFixed(2)}</td>
                  <td style="padding: 12px; text-align: right; font-size: 14px; font-weight: 600; color: #1a1a1a;">‚Çπ${(item.price * item.quantity).toFixed(2)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <div style="background: ${primaryColor}; padding: 20px; border-radius: 8px; text-align: right; margin-bottom: 40px;">
            <p style="margin: 0; font-size: 24px; font-weight: bold; color: white;">Total Amount: ‚Çπ${bill.total.toFixed(2)}</p>
          </div>

          <div class="footer-container" style="text-align: center; padding-top: 40px; border-top: 2px solid #e5e7eb;">
            ${settings.thankYouMessage ? `<p style="margin: 0 0 10px 0; font-size: 16px; font-weight: 600; color: #1a1a1a;">${settings.thankYouMessage}</p>` : ''}
            ${settings.footerNote ? `<p style="margin: 0; font-size: 12px; color: #6b7280;">${settings.footerNote}</p>` : ''}
          </div>
        </div>
        `;

      printArea.style.display = 'block';
      window.print();
      printArea.style.display = 'none';
    }

    function print80mmReceipt(bill, settings, items) {
      const printWindow = window.open('', '_blank', 'noopener,noreferrer');
      if (!printWindow) {
        showToast('Popup blocked. Please allow popups to print.', 'error');
        return;
      }

      const padRight = (s, n) => String(s ?? '').padEnd(n, ' ').slice(0, n);
      const padLeft = (s, n) => String(s ?? '').padStart(n, ' ').slice(0, n);
      const repeat = (ch, n) => new Array(n + 1).join(ch);

      // 80mm receipt target width (characters). 32 works well for Courier @ ~12px.
      const W = 32;
      const line = repeat('=', W);
      const dash = repeat('-', W);

      const center = (txt) => {
        const t = String(txt ?? '').trim();
        if (!t) return '';
        if (t.length >= W) return t.slice(0, W);
        const left = Math.floor((w - t.length) / 2);
        return repeat(' ', left) + t;
      };

      const money = (n) => {
        const symbol = (config.currency_symbol || defaultConfig.currency_symbol || '‚Çπ').trim();
        const v = Number(n || 0).toFixed(0); // thermal usually prints whole rupees
        return symbol + v;
      };

      const formatDate = (iso) => {
        try {
          return new Date(iso).toLocaleDateString('en-IN');
        } catch (_) {
          return String(iso || '');
        }
      };

      const headerLines = [
        line,
        center(settings.businessName || ''),
        settings.businessTagline ? center(settings.businessTagline) : '',
        dash,
      ].filter(Boolean);

      const address = String(settings.businessAddress || '').trim();
      const addressLines = address
        ? address
          .split(/\r?\n/)
          .flatMap((l) => {
            const s = l.trim();
            if (!s) return [];
            // hard wrap long address lines
            const out = [];
            for (let i = 0; i < s.length; i += W) out.push(center(s.slice(i, i + W)));
            return out;
          })
        : [];

      const phoneLine = settings.businessPhone ? center(`Phone : ${settings.businessPhone}`) : '';

      const itemsHeader = padRight('ITEM', 16) + padLeft('QTY', 4) + padLeft('RATE', 6) + padLeft('AMT', 6);

      const itemLines = items.flatMap((it) => {
        const name = String(it?.name ?? '').trim();
        const qty = Number(it?.quantity || 0);
        const rate = Number(it?.price || 0);
        const amt = rate * qty;

        // Split long names into multiple lines (first line with numbers, rest name-only)
        const chunks = [];
        for (let i = 0; i < name.length; i += 16) chunks.push(name.slice(i, i + 16));
        if (chunks.length === 0) chunks.push('');

        const first =
          padRight(chunks[0], 16) +
          padLeft(qty, 4) +
          padLeft(rate.toFixed(0), 6) +
          padLeft(amt.toFixed(0), 6);

        const rest = chunks.slice(1).map((c) => padRight(c, 16));
        return [first, ...rest];
      });

      const totalLine = padRight('TOTAL', 16) + padLeft('', 4) + padLeft('', 6) + padLeft(Number(bill.total || 0).toFixed(0), 6);

      const text = [
        ...headerLines,
        ...addressLines,
        phoneLine,
        line,
        `Bill No: ${bill.billNumber}   Date: ${formatDate(bill.date)
          }`.slice(0, W),
        dash,
        itemsHeader,
        dash,
        ...itemLines,
        dash,
        totalLine,
        dash,
        settings.thankYouMessage ? center(settings.thankYouMessage) : '',
        settings.footerNote ? center(settings.footerNote) : '',
        '',
      ]
        .filter((l) => l !== null && l !== undefined)
        .join('\n');

      printWindow.document.open();
      printWindow.document.write(`
      < !DOCTYPE html>
        <html>
          <head>
            <meta charset="utf-8" />
            <title>Receipt - ${bill.billNumber}</title>
            <style>
              @page {size: 80mm auto; margin: 0; }
              html, body {margin: 0; padding: 0; }
              body {font - family: 'Courier New', monospace; background: #fff; }
              pre {
                width: 80mm;
              padding: 5mm;
              font-size: 12px;
              line-height: 1.35;
              white-space: pre-wrap;
              word-break: break-word;
              }
            </style>
          </head>
          <body>
            <pre id="receipt"></pre>
            <script>
              document.getElementById('receipt').textContent = ${JSON.stringify(text)};
              window.print();
              <\/script>
          </body>

        </html>
    `);
      printWindow.document.close();
    }


    window.viewBillDetails = function (billId) {
      const bill = getBills().find(b => b.__backendId === billId);
      if (!bill) return;

      const items = JSON.parse(bill.items);
      const settings = getSettings();

      const content = `
      <div class="p-8">
  <h2 class="text-3xl font-bold mb-6" style="color: ${config.primary_color};">Bill #${bill.billNumber}</h2>

  <div class="grid grid-cols-2 gap-4 mb-6 p-4 rounded-lg bg-gray-50">
    <div>
      <div class="text-sm text-gray-600">Company</div>
      <div class="font-bold">${bill.companyName}</div>
    </div>
    <div>
      <div class="text-sm text-gray-600">Employee</div>
      <div class="font-bold">${bill.employeeName}</div>
    </div>
    <div>
      <div class="text-sm text-gray-600">Date</div>
      <div class="font-bold">${new Date(bill.date).toLocaleDateString('en-IN')}</div>
    </div>
    <div>
      <div class="text-sm text-gray-600">Status</div>
      <div class="font-bold ${bill.isPaid ? 'text-green-600' : 'text-red-600'}">
        ${bill.isPaid ? '‚úì Paid' : 'Pending'}
      </div>
    </div>
  </div>

  <h3 class="text-xl font-bold mb-4">Items</h3>
  <div class="space-y-2 mb-6">
    ${items.map(item => `
    <div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">
      <div>
        <div class="font-semibold">${item.name}</div>
        <div class="text-sm text-gray-600">${formatCurrency(item.price)} √ó ${item.quantity}</div>
      </div>
      <div class="font-bold" style="color: ${config.primary_color};">
        ${formatCurrency(item.price * item.quantity)}
      </div>
    </div>
    `).join('')}
  </div>

  <div class="border-t-2 pt-4 space-y-2 mb-6">
    <div class="flex justify-between">
      <span>Subtotal:</span>
      <span class="font-semibold">${formatCurrency(bill.subtotal)}</span>
    </div>
    <div class="flex justify-between">
      <span>Tax (${settings.taxRate}%):</span>
      <span class="font-semibold">${formatCurrency(bill.tax)}</span>
    </div>
    <div class="flex justify-between text-xl font-bold pt-2 border-t-2">
      <span>Total:</span>
      <span style="color: ${config.primary_color};">${formatCurrency(bill.total)}</span>
    </div>
    ${bill.paidAmount > 0 ? `
    <div class="flex justify-between text-green-600">
      <span>Paid:</span>
      <span class="font-semibold">${formatCurrency(bill.paidAmount)}</span>
    </div>
    ` : ''}
    ${(bill.total - bill.paidAmount) > 0 ? `
    <div class="flex justify-between text-red-600">
      <span>Pending:</span>
      <span class="font-semibold">${formatCurrency(bill.total - bill.paidAmount)}</span>
    </div>
    ` : ''}
  </div>

  <button type="button" onclick="closeModal()"
    class="w-full py-3 rounded-lg border-2 border-gray-300 font-semibold hover:bg-gray-50">
    Close
  </button>
</div>
      `;

      openModal(content);
    };

    // Manage Page
    function renderManagePage() {
      const baseSize = config.font_size || defaultConfig.font_size;

      const limitWarning = allData.length >= 999 ? `
      <div class="limit-warning mb-6">
        <div class="flex items-center gap-3">
          <span class="text-4xl">‚ö†Ô∏è</span>
          <div>
            <div class="font-bold text-red-800 text-lg">Maximum Limit Reached</div>
            <div class="text-red-600">You have reached the maximum limit of 999 records. You cannot add new companies or
              employees until you delete some items.</div>
          </div>
        </div>
</div>
      ` : '';

      return `
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <h2 class="text-3xl font-bold mb-6" style="color: ${config.primary_color}; font-size: ${baseSize * 2}px;">Manage
          Companies & Employees</h2>

  ${limitWarning}

    <div class="grid grid-cols-2 gap-6">
      <button type="button" onclick="openAddCompanyModal()" ${allData.length >= MAX_RECORDS ? 'disabled' : ''}
        class="p-8 rounded-xl border-2 ${allData.length >= MAX_RECORDS ? 'border-gray-300 bg-gray-100 cursor-not-allowed' : 'border-gray-300 hover:border-blue-500 hover:shadow-lg'} transition-all">
        <div class="text-5xl mb-3">üè¢</div>
        <div class="text-xl font-bold" style="font-size: ${baseSize * 1.3}px;">${allData.length >= MAX_RECORDS ? 'Limit Reached' : 'Add Company'}</div>
      </button>

      <button type="button" onclick="openAddEmployeeModal()" ${allData.length >= MAX_RECORDS ? 'disabled' : ''}
        class="p-8 rounded-xl border-2 ${allData.length >= MAX_RECORDS ? 'border-gray-300 bg-gray-100 cursor-not-allowed' : 'border-gray-300 hover:border-blue-500 hover:shadow-lg'} transition-all">
        <div class="text-5xl mb-3">üë§</div>
        <div class="text-xl font-bold" style="font-size: ${baseSize * 1.3}px;">${allData.length >= MAX_RECORDS ? 'Limit Reached' : 'Add Employee'}</div>
      </button>
    </div>
</div>
      `;
    }

    window.openAddCompanyModal = function () {
      if (allData.length >= 999) {
        showToast('Maximum limit of 999 records reached. Please delete some items first.', 'error');
        return;
      }

      const content = `
      <div class="p-8">
  <h2 class="text-3xl font-bold mb-6" style="color: ${config.primary_color};">Add New Company</h2>

  <form id="add-company-form" class="space-y-4">
    <div>
      <label for="company-name" class="block mb-2 font-semibold">Company Name *</label>
      <input type="text" id="company-name" required
        class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
        placeholder="Enter company name">
    </div>

    <div>
      <label for="company-contact" class="block mb-2 font-semibold">Contact Person</label>
      <input type="text" id="company-contact"
        class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
        placeholder="Contact person name">
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label for="company-phone" class="block mb-2 font-semibold">Phone</label>
        <input type="tel" id="company-phone"
          class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
          placeholder="Phone number">
      </div>

      <div>
        <label for="company-email" class="block mb-2 font-semibold">Email</label>
        <input type="email" id="company-email"
          class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
          placeholder="Email address">
      </div>
    </div>

    <div>
      <label for="company-address" class="block mb-2 font-semibold">Address</label>
      <textarea id="company-address" rows="3"
        class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
        placeholder="Company address"></textarea>
    </div>

    <div class="flex gap-3">
      <button type="button" onclick="closeModal()"
        class="flex-1 py-3 rounded-lg border-2 border-gray-300 font-semibold hover:bg-gray-50">
        Cancel
      </button>
      <button type="submit" id="save-company-btn" class="flex-1 py-3 rounded-lg text-white font-semibold"
        style="background-color: ${config.primary_color};">
        Save Company
      </button>
    </div>
  </form>
</div>
      `;

      openModal(content);
      document.getElementById('add-company-form').addEventListener('submit', handleAddCompany);
    };

    async function handleAddCompany(e) {
      e.preventDefault();

      if (isSubmitting) return;

      if (allData.length >= 999) {
        showToast('Maximum limit of 999 records reached. Please delete some items first.', 'error');
        return;
      }

      isSubmitting = true;
      const submitBtn = document.getElementById('save-company-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      const companyData = {
        type: 'company',
        name: document.getElementById('company-name').value.trim(),
        contactPerson: document.getElementById('company-contact').value.trim(),
        phone: document.getElementById('company-phone').value.trim(),
        email: document.getElementById('company-email').value.trim(),
        address: document.getElementById('company-address').value.trim(),
        timestamp: Date.now()
      };

      const result = await createRecord(companyData);
      if (result) {
        showToast('Company added successfully!');
        closeModal();
      }

      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save Company';
    }

    window.openAddEmployeeModal = function () {
      if (allData.length >= 999) {
        showToast('Maximum limit of 999 records reached. Please delete some items first.', 'error');
        return;
      }

      const companies = getCompanies();

      const content = `
      <div class="p-8">
  <h2 class="text-3xl font-bold mb-6" style="color: ${config.primary_color};">Add New Employee</h2>

  <form id="add-employee-form" class="space-y-4">
    <div>
      <label for="employee-company" class="block mb-2 font-semibold">Select Company *</label>
      <select id="employee-company" required
        class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none">
        <option value="">Choose Company</option>
        ${companies.map(c => `<option value="${c.__backendId}">${c.name}</option>`).join('')}
      </select>
    </div>

    <div>
      <label for="employee-name" class="block mb-2 font-semibold">Employee Name *</label>
      <input type="text" id="employee-name" required
        class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
        placeholder="Enter employee name">
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label for="employee-phone" class="block mb-2 font-semibold">Phone</label>
        <input type="tel" id="employee-phone"
          class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
          placeholder="Phone number">
      </div>

      <div>
        <label for="employee-email" class="block mb-2 font-semibold">Email</label>
        <input type="email" id="employee-email"
          class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
          placeholder="Email address">
      </div>
    </div>

    <div class="flex gap-3">
      <button type="button" onclick="closeModal()"
        class="flex-1 py-3 rounded-lg border-2 border-gray-300 font-semibold hover:bg-gray-50">
        Cancel
      </button>
      <button type="submit" id="save-employee-btn" class="flex-1 py-3 rounded-lg text-white font-semibold"
        style="background-color: ${config.primary_color};">
        Save Employee
      </button>
    </div>
  </form>
</div>
      `;

      openModal(content);
      document.getElementById('add-employee-form').addEventListener('submit', handleAddEmployee);
    };

    async function handleAddEmployee(e) {
      e.preventDefault();

      if (isSubmitting) return;

      if (allData.length >= 999) {
        showToast('Maximum limit of 999 records reached. Please delete some items first.', 'error');
        return;
      }

      isSubmitting = true;
      const submitBtn = document.getElementById('save-employee-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      const companyId = document.getElementById('employee-company').value;
      const company = getCompanies().find(c => c.__backendId === companyId);

      const employeeData = {
        type: 'employee',
        companyId: companyId,
        companyName: company.name,
        name: document.getElementById('employee-name').value.trim(),
        phone: document.getElementById('employee-phone').value.trim(),
        email: document.getElementById('employee-email').value.trim(),
        timestamp: Date.now()
      };

      const result = await createRecord(employeeData);
      if (result) {
        showToast('Employee added successfully!');
        closeModal();
      }

      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save Employee';
    }

    // Food Menu Page
    function renderFoodMenuPage() {
      const foodItems = getData('foodItem');
      const baseSize = config.font_size || defaultConfig.font_size;

      const itemsByCategory = {};
      FOOD_CATEGORIES.forEach(cat => {
        itemsByCategory[cat] = foodItems.filter(item => item.category === cat && item.isActive);
      });

      const limitWarning = allData.length >= 999 ? `
      <div class="limit-warning mb-6">
        <div class="flex items-center gap-3">
          <span class="text-4xl">‚ö†Ô∏è</span>
          <div>
            <div class="font-bold text-red-800 text-lg">Maximum Limit Reached</div>
            <div class="text-red-600">You have reached the maximum limit of 999 records. You cannot add new food items until
              you delete some items.</div>
          </div>
        </div>
</div>
      ` : '';

      return `
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-3xl font-bold" style="color: ${config.primary_color}; font-size: ${baseSize * 2}px;">Food Menu
            Management</h2>
          <button type="button" onclick="openAddFoodItemModal()" ${allData.length >= 999 ? 'disabled' : ''} class="px-6 py-3
      rounded-lg text-white font-semibold ${allData.length >= 999 ? 'bg-gray-400 cursor-not-allowed' : ''}"
            style="background-color: ${allData.length >= 999 ? '#9CA3AF' : config.primary_color}; font-size: ${baseSize}px;">
            ${allData.length >= 999 ? '‚ö†Ô∏è Limit Reached' : '‚ûï Add Food Item'}
          </button>
        </div>

  ${limitWarning}

    <div class="space-y-6 max-h-[600px] overflow-y-auto">
      ${FOOD_CATEGORIES.map(category => `
    <div>
      <div class="flex justify-between items-center mb-3 pb-2 border-b-2">
        <h3 class="text-xl font-bold" style="font-size: ${baseSize * 1.3}px;">${category}</h3>
        <span class="text-sm text-gray-600" style="font-size: ${baseSize * 0.9}px;">${itemsByCategory[category].length}
          items</span>
      </div>
      <div class="grid grid-cols-4 gap-3">
        ${itemsByCategory[category].length > 0 ? itemsByCategory[category].map(item => `
        <div class="p-3 rounded-lg border-2 border-gray-200 hover:shadow-md transition-all">
          <div class="font-semibold mb-1" style="font-size: ${baseSize}px;">${item.itemName}</div>
          <div class="font-bold text-lg" style="color: ${config.primary_color}; font-size: ${baseSize * 1.2}px;">
            ${formatCurrency(item.price)}</div>
          <button type="button" onclick="toggleFoodItem('${item.__backendId}')"
            class="mt-2 w-full py-1 text-xs rounded bg-red-100 text-red-600 hover:bg-red-200"
            style="font-size: ${baseSize * 0.8}px;">
            Delete
          </button>
        </div>
        `).join('') : '<div class="col-span-4 text-center text-gray-400 py-4">No items in this category</div>'}
      </div>
    </div>
    `).join('')}
    </div>
</div>
      `;
    }

    window.openAddFoodItemModal = function () {
      if (allData.length >= 999) {
        showToast('Maximum limit of 999 records reached. Please delete some items first.', 'error');
        return;
      }

      const content = `
      <div class="p-8">
  <h2 class="text-3xl font-bold mb-6" style="color: ${config.primary_color};">Add Food Item</h2>

  <form id="add-food-form" class="space-y-4">
    <div>
      <label for="food-name" class="block mb-2 font-semibold">Item Name *</label>
      <input type="text" id="food-name" required
        class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
        placeholder="Enter item name">
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label for="food-category" class="block mb-2 font-semibold">Category *</label>
        <select id="food-category" required
          class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none">
          <option value="">Select Category</option>
          ${FOOD_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
        </select>
      </div>

      <div>
        <label for="food-price" class="block mb-2 font-semibold">Price *</label>
        <input type="number" id="food-price" required step="0.01" min="0"
          class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
          placeholder="0.00">
      </div>
    </div>

    <div class="flex gap-3">
      <button type="button" onclick="closeModal()"
        class="flex-1 py-3 rounded-lg border-2 border-gray-300 font-semibold hover:bg-gray-50">
        Cancel
      </button>
      <button type="submit" id="save-food-btn" class="flex-1 py-3 rounded-lg text-white font-semibold"
        style="background-color: ${config.primary_color};">
        Save Item
      </button>
    </div>
  </form>
</div>
      `;

      openModal(content);
      document.getElementById('add-food-form').addEventListener('submit', handleAddFoodItem);
    };

    async function handleAddFoodItem(e) {
      e.preventDefault();

      if (isSubmitting) return;

      if (allData.length >= MAX_RECORDS) {
        showToast(`Maximum limit of ${MAX_RECORDS} records reached.Please delete some items first.`, 'error');
        return;
      }

      isSubmitting = true;
      const submitBtn = document.getElementById('save-food-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      const foodData = {
        type: 'foodItem',
        itemName: document.getElementById('food-name').value.trim(),
        category: document.getElementById('food-category').value,
        price: parseFloat(document.getElementById('food-price').value),
        isActive: true,
        timestamp: Date.now()
      };

      const result = await createRecord(foodData);
      if (result) {
        showToast('Food item added successfully!');
        closeModal();
      }

      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save Item';
    }

    window.toggleFoodItem = async function (itemId) {
      const item = allData.find(d => d.__backendId === itemId);
      if (!item) return;

      await updateRecord({
        ...item,
        isActive: false
      });

      showToast('Item deleted');
    };

    // Reports Page
    function renderReportsPage() {
      const baseSize = config.font_size || defaultConfig.font_size;
      const bills = getBills({ month: selectedMonth });
      const totalAmount = bills.reduce((sum, b) => sum + b.total, 0);
      const paidAmount = bills.reduce((sum, b) => sum + b.paidAmount, 0);
      const pending = totalAmount - paidAmount;

      return `
      <div class="bg-white rounded-2xl shadow-xl p-8">
  <h2 class="text-3xl font-bold mb-6" style="color: ${config.primary_color}; font-size: ${baseSize * 2}px;">Monthly
    Reports</h2>

  <div class="mb-6">
    <label for="report-month" class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">Select Month</label>
    <input type="month" id="report-month" value="${selectedMonth}"
      class="px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
      style="font-size: ${baseSize}px;">
  </div>

  <div class="grid grid-cols-3 gap-4 mb-6">
    <div class="p-4 rounded-lg" style="background-color: ${config.primary_color};">
      <div class="text-white opacity-90 text-sm" style="font-size: ${baseSize * 0.9}px;">Total Billed</div>
      <div class="text-2xl font-bold text-white mt-1" style="font-size: ${baseSize * 1.6}px;">
        ${formatCurrency(totalAmount)}</div>
      <div class="text-white opacity-80 text-xs mt-1" style="font-size: ${baseSize * 0.8}px;">${bills.length} bills
      </div>
    </div>
    <div class="p-4 rounded-lg bg-green-600">
      <div class="text-white opacity-90 text-sm" style="font-size: ${baseSize * 0.9}px;">Total Paid</div>
      <div class="text-2xl font-bold text-white mt-1" style="font-size: ${baseSize * 1.6}px;">
        ${formatCurrency(paidAmount)}</div>
    </div>
    <div class="p-4 rounded-lg ${pending > 0 ? 'bg-red-600' : 'bg-gray-400'}">
      <div class="text-white opacity-90 text-sm" style="font-size: ${baseSize * 0.9}px;">Pending</div>
      <div class="text-2xl font-bold text-white mt-1" style="font-size: ${baseSize * 1.6}px;">${formatCurrency(pending)}
      </div>
    </div>
  </div>

  <div class="space-y-3 max-h-96 overflow-y-auto">
    ${bills.length > 0 ? bills.map(bill => `
    <div class="border-2 border-gray-200 rounded-lg p-4">
      <div class="flex justify-between items-start mb-3">
        <div>
          <div class="font-bold text-lg" style="font-size: ${baseSize * 1.2}px;">Bill #${bill.billNumber}</div>
          <div class="text-sm text-gray-600" style="font-size: ${baseSize * 0.9}px;">${new
          Date(bill.date).toLocaleDateString('en-IN')}</div>
          <div class="text-sm mt-1" style="font-size: ${baseSize * 0.9}px;">${bill.companyName} - ${bill.employeeName}
          </div>
        </div>
        <div class="text-right">
          <div class="text-2xl font-bold" style="color: ${config.primary_color}; font-size: ${baseSize * 1.6}px;">
            ${formatCurrency(bill.total)}</div>
          <div class="text-sm ${bill.isPaid ? 'text-green-600' : 'text-red-600'}"
            style="font-size: ${baseSize * 0.9}px;">
            ${bill.isPaid ? '‚úì Paid' : `Due: ${formatCurrency(bill.total - bill.paidAmount)}`}
          </div>
        </div>
      </div>
      <div class="flex gap-2">
        <button type="button" onclick="viewBillDetails('${bill.__backendId}')"
          class="flex-1 py-2 rounded-lg border-2 border-gray-300 font-semibold hover:bg-gray-50"
          style="font-size: ${baseSize * 0.9}px;">
          View
        </button>
        <button type="button" onclick="editBill('${bill.__backendId}')"
          class="flex-1 py-2 rounded-lg border-2 border-blue-500 text-blue-600 font-semibold hover:bg-blue-50"
          style="font-size: ${baseSize * 0.9}px;">
          Edit
        </button>
        <button type="button" onclick="printBill('${bill.__backendId}')"
          class="flex-1 py-2 rounded-lg text-white font-semibold"
          style="background-color: ${config.primary_color}; font-size: ${baseSize * 0.9}px;">
          Print
        </button>
      </div>
    </div>
    `).join('') : `
    <div class="text-center py-12 text-gray-400">
      <div class="text-6xl mb-4">üìä</div>
      <div class="text-xl" style="font-size: ${baseSize * 1.3}px;">No bills in selected month</div>
    </div>
    `}
  </div>
</div>
      `;
    }

    // Settings Page
    function renderSettingsPage() {
      const settings = getSettings();
      const baseSize = config.font_size || defaultConfig.font_size;

      return `
      <div class="bg-white rounded-2xl shadow-xl p-8">
  <h2 class="text-3xl font-bold mb-6" style="color: ${config.primary_color}; font-size: ${baseSize * 2}px;">Settings
  </h2>

  <form id="settings-form" class="space-y-6">
    <div class="p-6 rounded-lg bg-gray-50">
      <h3 class="text-xl font-bold mb-4" style="font-size: ${baseSize * 1.3}px;">Business Information</h3>

      <div class="space-y-4">
        <div>
          <label for="business-name" class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">Business
            Name</label>
          <input type="text" id="business-name" value="${settings.businessName}"
            class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
            style="font-size: ${baseSize}px;">
        </div>

        <div>
          <label for="business-tagline" class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">Business
            Tagline</label>
          <input type="text" id="business-tagline" value="${settings.businessTagline || ''}"
            placeholder="e.g., Quality Service, Every Time"
            class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
            style="font-size: ${baseSize}px;">
        </div>

        <div>
          <label for="business-address" class="block mb-2 font-semibold"
            style="font-size: ${baseSize}px;">Address</label>
          <textarea id="business-address" rows="3"
            class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
            style="font-size: ${baseSize}px;">${settings.businessAddress || ''}</textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="business-phone" class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">Phone</label>
            <input type="tel" id="business-phone" value="${settings.businessPhone || ''}"
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
              style="font-size: ${baseSize}px;">
          </div>
          <div>
            <label for="gst-number" class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">GST
              Number</label>
            <input type="text" id="gst-number" value="${settings.gstNumber || ''}"
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
              style="font-size: ${baseSize}px;">
          </div>
        </div>
      </div>
    </div>

    <div class="p-6 rounded-lg bg-gray-50">
      <h3 class="text-xl font-bold mb-4" style="font-size: ${baseSize * 1.3}px;">Bill Messages</h3>

      <div class="space-y-4">
        <div>
          <label for="thank-you-message" class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">Thank You
            Message</label>
          <input type="text" id="thank-you-message" value="${settings.thankYouMessage || ''}"
            placeholder="Thank you for your business!"
            class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
            style="font-size: ${baseSize}px;">
        </div>

        <div>
          <label for="footer-note" class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">Footer
            Note</label>
          <input type="text" id="footer-note" value="${settings.footerNote || ''}"
            placeholder="This is a computer-generated bill"
            class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
            style="font-size: ${baseSize}px;">
        </div>
      </div>
    </div>

    <div class="p-6 rounded-lg bg-gray-50">
      <h3 class="text-xl font-bold mb-4" style="font-size: ${baseSize * 1.3}px;">Tax Settings</h3>

      <div>
        <label for="tax-rate" class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">Tax Rate (%)</label>
        <input type="number" id="tax-rate" value="${settings.taxRate}" step="0.1" min="0" max="100"
          class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
          style="font-size: ${baseSize}px;">
      </div>
    </div>

    <div class="p-6 rounded-lg bg-gray-50">
      <h3 class="text-xl font-bold mb-4" style="font-size: ${baseSize * 1.3}px;">Printer Settings</h3>

      <div>
        <label for="printer-type" class="block mb-2 font-semibold" style="font-size: ${baseSize}px;">Receipt
          Format</label>
        <select id="printer-type"
          class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
          style="font-size: ${baseSize}px;">
          <option value="A4" ${settings.printerType === 'A4' ? 'selected' : ''}>A4 (Standard)</option>
          <option value="80mm" ${settings.printerType === '80mm' ? 'selected' : ''}>80mm (Thermal)</option>
        </select>
      </div>
    </div>

    <button type="submit" id="save-settings-btn" class="w-full py-4 rounded-lg text-white font-bold text-lg"
      style="background-color: ${config.primary_color}; font-size: ${baseSize * 1.1}px;">
      Save Settings
    </button>
  </form>
</div>
      `;
    }

    async function handleSaveSettings(e) {
      e.preventDefault();

      if (isSubmitting) return;

      isSubmitting = true;
      const submitBtn = document.getElementById('save-settings-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      const settingsData = {
        type: 'settings',
        businessName: document.getElementById('business-name').value.trim(),
        businessTagline: document.getElementById('business-tagline').value.trim(),
        businessAddress: document.getElementById('business-address').value.trim(),
        businessPhone: document.getElementById('business-phone').value.trim(),
        gstNumber: document.getElementById('gst-number').value.trim(),
        taxRate: parseFloat(document.getElementById('tax-rate').value),
        printerType: document.getElementById('printer-type').value,
        thankYouMessage: document.getElementById('thank-you-message').value.trim(),
        footerNote: document.getElementById('footer-note').value.trim(),
        timestamp: Date.now()
      };

      const existingSettings = getData('settings');

      if (existingSettings.length > 0) {
        await updateRecord({
          ...existingSettings[0],
          ...settingsData
        });
      } else {
        await createRecord(settingsData);
      }

      showToast('Settings saved successfully!');

      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save Settings';
    }

    // Navigation
    window.navigateToPage = function (page) {
      currentPage = page;
      render();
    };

    // Render Dashboard
    function renderDashboard() {
      const baseSize = config.font_size || defaultConfig.font_size;

      const today = new Date().toDateString();
      const todayBills = getBills().filter(b => new Date(b.date).toDateString() === today);
      const todayRevenue = todayBills.reduce((sum, b) => sum + b.total, 0);

      const currentMonth = new Date().toISOString().slice(0, 7);
      const monthBills = getBills({ month: currentMonth });
      const monthRevenue = monthBills.reduce((sum, b) => sum + b.total, 0);

      const allBills = getBills();
      const totalRevenue = allBills.reduce((sum, b) => sum + b.total, 0);

      const bgColor = config.background_color || defaultConfig.background_color;

      return `
      <div style="background: linear-gradient(135deg, ${bgColor} 0%, #764ba2 100%); height: 100%;">
        <div class="max-w-7xl mx-auto px-4 py-8">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-card rounded-2xl p-6 transform hover:scale-[1.02] transition-all duration-300">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm font-semibold uppercase tracking-wider">Today's Sales</p>
                  <p class="text-4xl font-extrabold text-gray-800 mt-2">${formatCurrency(todayRevenue)}</p>
                  <div class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 mt-2">
                    ${todayBills.length} bills today
                  </div>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-indigo-600 p-4 rounded-2xl shadow-lg">
                  <span class="text-3xl">üí∞</span>
                </div>
              </div>
            </div>

            <div class="glass-card rounded-2xl p-6 transform hover:scale-[1.02] transition-all duration-300">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm font-semibold uppercase tracking-wider">Monthly Total</p>
                  <p class="text-4xl font-extrabold text-gray-800 mt-2">${formatCurrency(monthRevenue)}</p>
                  <div class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mt-2">
                    ${monthBills.length} bills this month
                  </div>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-cyan-600 p-4 rounded-2xl shadow-lg">
                  <span class="text-3xl">üìä</span>
                </div>
              </div>
            </div>

            <div class="glass-card rounded-2xl p-6 transform hover:scale-[1.02] transition-all duration-300">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm font-semibold uppercase tracking-wider">All Time</p>
                  <p class="text-4xl font-extrabold text-gray-800 mt-2">${formatCurrency(totalRevenue)}</p>
                  <div class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 mt-2">
                    ${allBills.length} total bills
                  </div>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-emerald-600 p-4 rounded-2xl shadow-lg">
                  <span class="text-3xl">üéØ</span>
                </div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <button type="button" onclick="navigateToPage('newbill')"
              class="glass-card rounded-2xl p-6 hover:shadow-2xl transform hover:-translate-y-2 transition-all duration-300 group">
              <div class="text-5xl mb-3 transform group-hover:scale-110 transition-transform duration-300">üìù</div>
              <div class="font-bold text-gray-800">New Bill</div>
            </button>

            <button type="button" onclick="navigateToPage('companies')"
              class="glass-card rounded-2xl p-6 hover:shadow-2xl transform hover:-translate-y-2 transition-all duration-300 group">
              <div class="text-5xl mb-3 transform group-hover:scale-110 transition-transform duration-300">üè¢</div>
              <div class="font-bold text-gray-800">Companies</div>
            </button>

            <button type="button" onclick="navigateToPage('manage')"
              class="glass-card rounded-2xl p-6 hover:shadow-2xl transform hover:-translate-y-2 transition-all duration-300 group">
              <div class="text-5xl mb-3 transform group-hover:scale-110 transition-transform duration-300">üë•</div>
              <div class="font-bold text-gray-800">Manage</div>
            </button>

            <button type="button" onclick="navigateToPage('foodmenu')"
              class="glass-card rounded-2xl p-6 hover:shadow-2xl transform hover:-translate-y-2 transition-all duration-300 group">
              <div class="text-5xl mb-3 transform group-hover:scale-110 transition-transform duration-300">üçΩÔ∏è</div>
              <div class="font-bold text-gray-800">Food Menu</div>
            </button>

            <button type="button" onclick="navigateToPage('reports')"
              class="glass-card rounded-2xl p-6 hover:shadow-2xl transform hover:-translate-y-2 transition-all duration-300 group">
              <div class="text-5xl mb-3 transform group-hover:scale-110 transition-transform duration-300">üìä</div>
              <div class="font-bold text-gray-800">Reports</div>
            </button>

            <button type="button" onclick="navigateToPage('settings')"
              class="glass-card rounded-2xl p-6 hover:shadow-2xl transform hover:-translate-y-2 transition-all duration-300 group">
              <div class="text-5xl mb-3 transform group-hover:scale-110 transition-transform duration-300">‚öôÔ∏è</div>
              <div class="font-bold text-gray-800">Settings</div>
            </button>
          </div>

          <div class="glass-card rounded-2xl p-8 mb-8">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-extrabold text-gray-800">Recent Transactions</h2>
              <button type="button" onclick="navigateToPage('reports')" class="text-purple-600 font-bold hover:text-purple-800 transition-colors">View All ‚Üí</button>
            </div>
            <div class="space-y-4">
              ${allBills.slice(0, 10).length > 0 ? allBills.slice(0, 10).map(bill => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
          <div class="flex-1">
            <div class="font-bold text-gray-800">Bill #${bill.billNumber}</div>
            <div class="text-sm text-gray-600">${bill.companyName} - ${bill.employeeName}</div>
            <div class="text-xs text-gray-500">${new Date(bill.date).toLocaleDateString('en-IN')}</div>
          </div>
          <div class="text-right mr-6">
            <div class="font-bold text-xl text-purple-600">${formatCurrency(bill.total)}</div>
            <div class="text-xs ${bill.isPaid ? 'text-green-600' : 'text-red-600'}">
              ${bill.isPaid ? '‚úì Paid' : `Due: ${formatCurrency(bill.total - bill.paidAmount)}`}
            </div>
          </div>
          <button type="button" onclick="viewBillDetails('${bill.__backendId}')"
            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
            View
          </button>
        </div>
        `).join('') : `
        <div class="text-center py-12 text-gray-400">
          <div class="text-6xl mb-4">üìã</div>
          <div class="text-xl font-semibold">No bills yet</div>
          <button type="button" onclick="navigateToPage('newbill')"
            class="mt-6 px-8 py-3 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700 transition-colors">
            Create Your First Bill
          </button>
        </div>
        `}
            </div>
          </div>
        </div>
</div>
      `;
    }

    // Main Render
    function render() {
      const app = document.getElementById('app');
      const loadingScreen = document.getElementById('loading-screen');

      // Hide loading screen if it exists
      if (loadingScreen) {
        loadingScreen.style.display = 'none';
      }

      // Show error state if initialization failed
      if (hasInitError) {
        app.innerHTML = renderErrorState();
        return;
      }

      const baseSize = config.font_size || defaultConfig.font_size;
      const fontFamily = config.font_family || defaultConfig.font_family;

      let pageContent = '';
      let showBackButton = false;

      switch (currentPage) {
        case 'newbill':
          pageContent = renderNewBillPage();
          showBackButton = true;
          break;
        case 'companies':
          pageContent = renderCompaniesPage();
          showBackButton = true;
          break;
        case 'manage':
          pageContent = renderManagePage();
          showBackButton = true;
          break;
        case 'foodmenu':
          pageContent = renderFoodMenuPage();
          showBackButton = true;
          break;
        case 'reports':
          pageContent = renderReportsPage();
          showBackButton = true;
          break;
        case 'settings':
          pageContent = renderSettingsPage();
          showBackButton = true;
          break;
        default:
          pageContent = renderDashboard();
          showBackButton = false;
      }

      const bgColor = config.background_color || defaultConfig.background_color;

      app.innerHTML = `
      <div class="w-full h-full"
    style="background: linear-gradient(135deg, ${bgColor} 0%, #764ba2 100%); font-family: ${fontFamily}, sans-serif;">
      <div class="max-w-[1600px] mx-auto px-6 py-8">
        <header class="mb-8 flex items-center justify-between">
          <div class="flex items-center gap-6">
            <div class="bg-white p-4 rounded-3xl shadow-2xl transform rotate-3 hover:rotate-0 transition-transform duration-500">
              <span class="text-5xl">üíé</span>
            </div>
            <div>
              <h1 class="text-5xl font-black text-white tracking-tight drop-shadow-lg" style="font-size: ${baseSize * 2.8}px;">
                ${config.app_title || defaultConfig.app_title}
              </h1>
              <div class="flex items-center gap-2 mt-2">
                <span class="w-8 h-1 bg-white rounded-full opacity-50"></span>
                <p class="text-white font-medium opacity-90" style="font-size: ${baseSize * 1.1}px;">
                  Enterprise Billing Solution
                </p>
              </div>
            </div>
          </div>
          ${showBackButton ? `
      <button type="button" onclick="navigateToPage('dashboard')"
        class="px-6 py-3 bg-white rounded-lg font-semibold hover:shadow-lg transition-all"
        style="color: ${config.primary_color}; font-size: ${baseSize}px;">
        ÔøΩÔøΩÔøΩ Back to Dashboard
      </button>
      ` : ''}
        </header>

        ${pageContent}
      </div>
</div>
`;

      // Attach event listeners based on current page
      if (currentPage === 'newbill') {
        setTimeout(() => {
          const companySelect = document.getElementById('bill-company');
          const categorySelect = document.getElementById('bill-category');
          const billForm = document.getElementById('new-bill-form');
          const savePrintBtn = document.getElementById('save-print-bill-btn');

          if (companySelect) companySelect.addEventListener('change', handleCompanyChange);
          if (categorySelect) categorySelect.addEventListener('change', loadFoodItems);
          if (billForm) billForm.addEventListener('submit', handleCreateBill);
          if (savePrintBtn) savePrintBtn.addEventListener('click', handleSaveAndPrintBill);

          loadFoodItems();
        }, 0);
      }

      if (currentPage === 'reports') {
        setTimeout(() => {
          const monthInput = document.getElementById('report-month');
          if (monthInput) {
            monthInput.addEventListener('change', (e) => {
              selectedMonth = e.target.value;
              render();
            });
          }
        }, 0);
      }

      if (currentPage === 'settings') {
        setTimeout(() => {
          const settingsForm = document.getElementById('settings-form');
          if (settingsForm) {
            settingsForm.addEventListener('submit', handleSaveSettings);
          }
        }, 0);
      }
    }

    // Elements SDK Integration
    async function onConfigChange(newConfig) {
      config = { ...config, ...newConfig };

      // Re-render the entire app with new config
      render();
    }

    // Initialize Elements SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig: defaultConfig,
        onConfigChange: onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                config.primary_color = value;
                window.elementSdk.setConfig({ primary_color: value });
              }
            },
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.card_color || defaultConfig.card_color,
              set: (value) => {
                config.card_color = value;
                window.elementSdk.setConfig({ card_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.success_color || defaultConfig.success_color,
              set: (value) => {
                config.success_color = value;
                window.elementSdk.setConfig({ success_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (value) => {
              config.font_family = value;
              window.elementSdk.setConfig({ font_family: value });
            }
          },
          fontSizeable: {
            get: () => config.font_size || defaultConfig.font_size,
            set: (value) => {
              config.font_size = value;
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ["app_title", config.app_title || defaultConfig.app_title],
          ["business_name", config.business_name || defaultConfig.business_name],
          ["business_tagline", config.business_tagline || defaultConfig.business_tagline],
          ["thank_you_message", config.thank_you_message || defaultConfig.thank_you_message],
          ["footer_note", config.footer_note || defaultConfig.footer_note]
        ])
      });
    }

    // Initialize
    function __hideLoadingScreen() {
      const el = document.getElementById('loading-screen');
      if (!el) return;
      el.style.transition = 'opacity 180ms ease';
      el.style.opacity = '0';
      setTimeout(() => el.remove(), 220);
    }

    async function init() {
      try {
        // Wait for Data SDK to be available (loaded by deferred script)
        let retries = 0;
        const maxRetries = 50; // 5 seconds total
        while (!window.dataSdk && retries < maxRetries) {
          await new Promise(resolve => setTimeout(resolve, 100));
          retries++;
        }

        if (!window.dataSdk) {
          throw new Error('Data SDK failed to load after 5 seconds');
        }

        await initDataSdk();

        // Show loading screen for at least 500ms for smooth transition
        await new Promise(resolve => setTimeout(resolve, 500));

        // Render the app
        render();

        // Hide loader when UI is present
        requestAnimationFrame(() => {
          const app = document.getElementById('app');
          if (app && app.firstElementChild) __hideLoadingScreen();
          else {
            const obs = new MutationObserver(() => {
              const a = document.getElementById('app');
              if (a && a.firstElementChild) {
                obs.disconnect();
                __hideLoadingScreen();
              }
            });
            const a = document.getElementById('app');
            if (a) obs.observe(a, { childList: true, subtree: true });
          }
        });
      } catch (error) {
        console.error('Fatal initialization error:', error);
        hasInitError = true;
        render();
        __hideLoadingScreen();
      }
    }

    // Global function exports
    window.recordPayment = recordPayment;

    // Wait for DOM and deferred scripts, then initialize
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>

</html>